<!DOCTYPE html>
  <html>
    <head>
      <title>kubespray-docs</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///C:\Users\wangwg2\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.3.2\node_modules\@shd101wyy\mume\dependencies\katex\katex.min.css">
      
      
      
      
      
      
      
      
      

      <style> 
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
html body {
  font-size: 14px;
  /* 等宽字体 */
  /* 非等宽字体 */
}
html body h1,
html body h2,
html body h3,
html body h4,
html body h5,
html body h6 {
  font-family: "Microsoft YaHei", "Courier New", sans-serif;
}
html body pre,
html body code {
  font-family: "Microsoft YaHei Mono", "Monaco", "Courier New", "Microsoft YaHei", "DejaVu Sans Mono", "Bitstream Vera Sans Mono", sans-serif;
}
 
      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview   ">
      <h6 class="mume-header" id="ansible-playbook">ansible-playbook</h6>

<p><code>ansible-playbook -b -i inventory/inventory.cfg cluster.yml</code></p>
<pre class="language-yaml {as=&quot;yaml&quot;}"><span class="token comment" spellcheck="true"># file: inventory.cfg</span>
<span class="token punctuation">[</span>all<span class="token punctuation">]</span>
test    ansible_host=192.168.99.30
test01  ansible_host=192.168.99.31
test02  ansible_host=192.168.99.32
test03  ansible_host=192.168.99.33

<span class="token punctuation">[</span>all<span class="token punctuation">:</span>vars<span class="token punctuation">]</span>
ansible_connection=ssh
ansible_user=vagrant

<span class="token punctuation">[</span>kube<span class="token punctuation">-</span>master<span class="token punctuation">]</span>
test

<span class="token punctuation">[</span>etcd<span class="token punctuation">]</span>
test
test01
test02

<span class="token punctuation">[</span>kube<span class="token punctuation">-</span>node<span class="token punctuation">]</span>
test01
test02
test03

<span class="token punctuation">[</span>k8s<span class="token punctuation">-</span>cluster<span class="token punctuation">:</span>children<span class="token punctuation">]</span>
kube<span class="token punctuation">-</span>node
kube<span class="token punctuation">-</span>master
</pre>
<pre class="language-yml"><span class="token comment" spellcheck="true"># file: cluster.yml</span>
<span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> localhost
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults<span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> bastion<span class="token punctuation">-</span>ssh<span class="token punctuation">-</span>config<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token string">"bastion"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>cluster<span class="token punctuation">:</span>etcd<span class="token punctuation">:</span>calico<span class="token punctuation">-</span>rr
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"{{ any_errors_fatal | default(true) }}"</span>
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">vars</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># Need to disable pipelining for bootstrap-os as some systems have requiretty in sudoers set, which makes pipelining</span>
    <span class="token comment" spellcheck="true"># fail. bootstrap-os fixes this on these systems, so in later plays it can be enabled.</span>
    <span class="token key atrule">ansible_ssh_pipelining</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults<span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> bootstrap<span class="token punctuation">-</span>os<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> bootstrap<span class="token punctuation">-</span>os<span class="token punctuation">}</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>cluster<span class="token punctuation">:</span>etcd<span class="token punctuation">:</span>calico<span class="token punctuation">-</span>rr
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"{{ any_errors_fatal | default(true) }}"</span>
  <span class="token key atrule">vars</span><span class="token punctuation">:</span>
    <span class="token key atrule">ansible_ssh_pipelining</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>cluster<span class="token punctuation">:</span>etcd<span class="token punctuation">:</span>calico<span class="token punctuation">-</span>rr
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"{{ any_errors_fatal | default(true) }}"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults<span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes/preinstall<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> preinstall <span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> docker<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> docker <span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> rkt
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> rkt
      <span class="token key atrule">when</span><span class="token punctuation">:</span> <span class="token string">"'rkt' in [etcd_deployment_type, kubelet_deployment_type, vault_deployment_type]"</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> download<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> download<span class="token punctuation">,</span> <span class="token key atrule">skip_downloads</span><span class="token punctuation">:</span> <span class="token boolean important">false </span><span class="token punctuation">}</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"{{proxy_env}}"</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> etcd<span class="token punctuation">:</span>k8s<span class="token punctuation">-</span>cluster<span class="token punctuation">:</span>vault<span class="token punctuation">:</span>calico<span class="token punctuation">-</span>rr
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"{{ any_errors_fatal | default(true) }}"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults<span class="token punctuation">,</span> <span class="token key atrule">when</span><span class="token punctuation">:</span> <span class="token string">"cert_management == 'vault'"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> vault<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> vault<span class="token punctuation">,</span> <span class="token key atrule">vault_bootstrap</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span> <span class="token key atrule">when</span><span class="token punctuation">:</span> <span class="token string">"cert_management == 'vault'"</span> <span class="token punctuation">}</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"{{proxy_env}}"</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> etcd
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"{{ any_errors_fatal | default(true) }}"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults<span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> etcd<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> etcd<span class="token punctuation">,</span> <span class="token key atrule">etcd_cluster_setup</span><span class="token punctuation">:</span> <span class="token boolean important">true </span><span class="token punctuation">}</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>cluster<span class="token punctuation">:</span>calico<span class="token punctuation">-</span>rr
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"{{ any_errors_fatal | default(true) }}"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults<span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> etcd<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> etcd<span class="token punctuation">,</span> <span class="token key atrule">etcd_cluster_setup</span><span class="token punctuation">:</span> <span class="token boolean important">false </span><span class="token punctuation">}</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> etcd<span class="token punctuation">:</span>k8s<span class="token punctuation">-</span>cluster<span class="token punctuation">:</span>vault<span class="token punctuation">:</span>calico<span class="token punctuation">-</span>rr
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"{{ any_errors_fatal | default(true) }}"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults<span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> vault<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> vault<span class="token punctuation">,</span> <span class="token key atrule">when</span><span class="token punctuation">:</span> <span class="token string">"cert_management == 'vault'"</span><span class="token punctuation">}</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"{{proxy_env}}"</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>cluster
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"{{ any_errors_fatal | default(true) }}"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults<span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes/node<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> node <span class="token punctuation">}</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"{{proxy_env}}"</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>master
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"{{ any_errors_fatal | default(true) }}"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults<span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes/master<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> master <span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes/client<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> client <span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>apps/cluster_roles<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> cluster<span class="token punctuation">-</span>roles <span class="token punctuation">}</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>cluster
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"{{ any_errors_fatal | default(true) }}"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults<span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes/kubeadm<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> kubeadm<span class="token punctuation">,</span> <span class="token key atrule">when</span><span class="token punctuation">:</span> <span class="token string">"kubeadm_enabled"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> network_plugin<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> network <span class="token punctuation">}</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>master<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"{{ any_errors_fatal | default(true) }}"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults<span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>apps/rotate_tokens<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> rotate_tokens<span class="token punctuation">,</span> <span class="token key atrule">when</span><span class="token punctuation">:</span> <span class="token string">"secret_changed|default(false)"</span> <span class="token punctuation">}</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>master
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"{{ any_errors_fatal | default(true) }}"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults<span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>apps/network_plugin<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> network <span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>apps/policy_controller<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> policy<span class="token punctuation">-</span>controller <span class="token punctuation">}</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>rr
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"{{ any_errors_fatal | default(true) }}"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults<span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> network_plugin/calico/rr<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> network <span class="token punctuation">}</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>cluster
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"{{ any_errors_fatal | default(true) }}"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults<span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> dnsmasq<span class="token punctuation">,</span> <span class="token key atrule">when</span><span class="token punctuation">:</span> <span class="token string">"dns_mode == 'dnsmasq_kubedns'"</span><span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> dnsmasq <span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes/preinstall<span class="token punctuation">,</span> <span class="token key atrule">when</span><span class="token punctuation">:</span> <span class="token string">"dns_mode != 'none' and resolvconf_mode == 'host_resolvconf'"</span><span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> resolvconf <span class="token punctuation">}</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"{{proxy_env}}"</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>master<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"{{ any_errors_fatal | default(true) }}"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults<span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>apps<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> apps <span class="token punctuation">}</span>

</pre>
<hr>
<h6 class="mume-header" id="role-kubespray-defaults">role: kubespray-defaults</h6>

<p><code>roles/kubespray-defaults/defaults/main.yaml</code></p>
<pre class="language-yaml"><span class="token punctuation">---</span>
<span class="token comment" spellcheck="true">## Required for bootstrap-os/preinstall/download roles and setting facts</span>
<span class="token comment" spellcheck="true"># Valid bootstrap options (required): ubuntu, coreos, centos, none</span>
<span class="token key atrule">bootstrap_os</span><span class="token punctuation">:</span> none

<span class="token comment" spellcheck="true"># Use proxycommand if bastion host is in group all</span>
<span class="token comment" spellcheck="true"># This change obseletes editing ansible.cfg file depending on bastion existance</span>
<span class="token key atrule">ansible_ssh_common_args</span><span class="token punctuation">:</span> <span class="token string">"{% if 'bastion' in groups['all'] %} -o ProxyCommand='ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -W %h:%p {{ ansible_user }}@{{hostvars['bastion']['ansible_host']}} ' {% endif %}"</span>

<span class="token key atrule">kube_api_anonymous_auth</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment" spellcheck="true"># Default value, but will be set to true automatically if detected</span>
<span class="token key atrule">is_atomic</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment" spellcheck="true">## Change this to use another Kubernetes version, e.g. a current beta release</span>
<span class="token key atrule">kube_version</span><span class="token punctuation">:</span> v1.9.0

<span class="token comment" spellcheck="true"># Set to true to allow pre-checks to fail and continue deployment</span>
<span class="token key atrule">ignore_assert_errors</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment" spellcheck="true"># Directory where the binaries will be installed</span>
<span class="token key atrule">bin_dir</span><span class="token punctuation">:</span> /usr/local/bin
<span class="token key atrule">docker_bin_dir</span><span class="token punctuation">:</span> /usr/bin
<span class="token key atrule">etcd_data_dir</span><span class="token punctuation">:</span> /var/lib/etcd
<span class="token comment" spellcheck="true"># Where the binaries will be downloaded.</span>
<span class="token comment" spellcheck="true"># Note: ensure that you've enough disk space (about 1G)</span>
<span class="token key atrule">local_release_dir</span><span class="token punctuation">:</span> <span class="token string">"/tmp/releases"</span>
<span class="token comment" spellcheck="true"># Random shifts for retrying failed ops like pushing/downloading</span>
<span class="token key atrule">retry_stagger</span><span class="token punctuation">:</span> <span class="token number">5</span>

<span class="token comment" spellcheck="true"># DNS configuration.</span>
<span class="token comment" spellcheck="true"># Kubernetes cluster name, also will be used as DNS domain</span>
<span class="token key atrule">cluster_name</span><span class="token punctuation">:</span> cluster.local
<span class="token comment" spellcheck="true"># Subdomains of DNS domain to be resolved via /etc/resolv.conf for hostnet pods</span>
<span class="token key atrule">ndots</span><span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token comment" spellcheck="true"># Can be dnsmasq_kubedns, kubedns or none</span>
<span class="token key atrule">dns_mode</span><span class="token punctuation">:</span> kubedns
<span class="token comment" spellcheck="true"># Can be docker_dns, host_resolvconf or none</span>
<span class="token key atrule">resolvconf_mode</span><span class="token punctuation">:</span> docker_dns
<span class="token comment" spellcheck="true"># Deploy netchecker app to verify DNS resolve as an HTTP service</span>
<span class="token key atrule">deploy_netchecker</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token comment" spellcheck="true"># Ip address of the kubernetes skydns service</span>
<span class="token key atrule">skydns_server</span><span class="token punctuation">:</span> <span class="token string">"{{ kube_service_addresses|ipaddr('net')|ipaddr(3)|ipaddr('address') }}"</span>
<span class="token key atrule">dnsmasq_dns_server</span><span class="token punctuation">:</span> <span class="token string">"{{ kube_service_addresses|ipaddr('net')|ipaddr(2)|ipaddr('address') }}"</span>
<span class="token key atrule">dns_domain</span><span class="token punctuation">:</span> <span class="token string">"{{ cluster_name }}"</span>

<span class="token comment" spellcheck="true"># Kubernetes configuration dirs and system namespace.</span>
<span class="token comment" spellcheck="true"># Those are where all the additional config stuff goes</span>
<span class="token comment" spellcheck="true"># the kubernetes normally puts in /srv/kubernets.</span>
<span class="token comment" spellcheck="true"># This puts them in a sane location and namespace.</span>
<span class="token comment" spellcheck="true"># Editting those values will almost surely break something.</span>
<span class="token key atrule">kube_config_dir</span><span class="token punctuation">:</span> /etc/kubernetes
<span class="token key atrule">kube_script_dir</span><span class="token punctuation">:</span> <span class="token string">"{{ bin_dir }}/kubernetes-scripts"</span>
<span class="token key atrule">kube_manifest_dir</span><span class="token punctuation">:</span> <span class="token string">"{{ kube_config_dir }}/manifests"</span>
<span class="token key atrule">system_namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system

<span class="token comment" spellcheck="true"># This is where all the cert scripts and certs will be located</span>
<span class="token key atrule">kube_cert_dir</span><span class="token punctuation">:</span> <span class="token string">"{{ kube_config_dir }}/ssl"</span>

<span class="token comment" spellcheck="true"># This is where all of the bearer tokens will be stored</span>
<span class="token key atrule">kube_token_dir</span><span class="token punctuation">:</span> <span class="token string">"{{ kube_config_dir }}/tokens"</span>

<span class="token comment" spellcheck="true"># This is where to save basic auth file</span>
<span class="token key atrule">kube_users_dir</span><span class="token punctuation">:</span> <span class="token string">"{{ kube_config_dir }}/users"</span>


<span class="token comment" spellcheck="true"># This is the group that the cert creation scripts chgrp the</span>
<span class="token comment" spellcheck="true"># cert files to. Not really changable...</span>
<span class="token key atrule">kube_cert_group</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>cert

<span class="token comment" spellcheck="true"># Cluster Loglevel configuration</span>
<span class="token key atrule">kube_log_level</span><span class="token punctuation">:</span> <span class="token number">2</span>

<span class="token comment" spellcheck="true"># Users to create for basic auth in Kubernetes API via HTTP</span>
<span class="token key atrule">kube_api_pwd</span><span class="token punctuation">:</span> <span class="token string">"changeme"</span>
<span class="token key atrule">kube_users</span><span class="token punctuation">:</span>
  <span class="token key atrule">kube</span><span class="token punctuation">:</span>
    <span class="token key atrule">pass</span><span class="token punctuation">:</span> <span class="token string">"{{kube_api_pwd}}"</span>
    <span class="token key atrule">role</span><span class="token punctuation">:</span> admin

<span class="token comment" spellcheck="true"># Choose network plugin (calico, weave or flannel)</span>
<span class="token comment" spellcheck="true"># Can also be set to 'cloud', which lets the cloud provider setup appropriate routing</span>
<span class="token key atrule">kube_network_plugin</span><span class="token punctuation">:</span> calico

<span class="token comment" spellcheck="true"># Determines if calico-rr group exists</span>
<span class="token key atrule">peer_with_calico_rr</span><span class="token punctuation">:</span> <span class="token string">"{{ 'calico-rr' in groups and groups['calico-rr']|length > 0 }}"</span>

<span class="token comment" spellcheck="true"># Kubernetes internal network for services, unused block of space.</span>
<span class="token key atrule">kube_service_addresses</span><span class="token punctuation">:</span> 10.233.0.0/18

<span class="token comment" spellcheck="true"># internal network. When used, it will assign IP</span>
<span class="token comment" spellcheck="true"># addresses from this range to individual pods.</span>
<span class="token comment" spellcheck="true"># This network must be unused in your network infrastructure!</span>
<span class="token key atrule">kube_pods_subnet</span><span class="token punctuation">:</span> 10.233.64.0/18

<span class="token comment" spellcheck="true"># internal network node size allocation (optional). This is the size allocated</span>
<span class="token comment" spellcheck="true"># to each node on your network.  With these defaults you should have</span>
<span class="token comment" spellcheck="true"># room for 4096 nodes with 254 pods per node.</span>
<span class="token key atrule">kube_network_node_prefix</span><span class="token punctuation">:</span> <span class="token number">24</span>

<span class="token comment" spellcheck="true"># The virtual cluster IP, real host IPs and ports the API Server will be</span>
<span class="token comment" spellcheck="true"># listening on.</span>
<span class="token comment" spellcheck="true"># NOTE: loadbalancer_apiserver_localhost somewhat alters the final API enpdoint</span>
<span class="token comment" spellcheck="true"># access IP value (automatically evaluated below)</span>
<span class="token key atrule">kube_apiserver_ip</span><span class="token punctuation">:</span> <span class="token string">"{{ kube_service_addresses|ipaddr('net')|ipaddr(1)|ipaddr('address') }}"</span>
<span class="token key atrule">kube_apiserver_bind_address</span><span class="token punctuation">:</span> 0.0.0.0
<span class="token comment" spellcheck="true"># https</span>
<span class="token key atrule">kube_apiserver_port</span><span class="token punctuation">:</span> <span class="token number">6443</span>
<span class="token comment" spellcheck="true"># http</span>
<span class="token key atrule">kube_apiserver_insecure_bind_address</span><span class="token punctuation">:</span> 127.0.0.1
<span class="token key atrule">kube_apiserver_insecure_port</span><span class="token punctuation">:</span> <span class="token number">8080</span>

<span class="token comment" spellcheck="true"># Path used to store Docker data</span>
<span class="token key atrule">docker_daemon_graph</span><span class="token punctuation">:</span> <span class="token string">"/var/lib/docker"</span>

<span class="token comment" spellcheck="true"># Docker log options</span>
<span class="token comment" spellcheck="true"># Rotate container stderr/stdout logs at 50m and keep last 5</span>
<span class="token key atrule">docker_log_opts</span><span class="token punctuation">:</span> <span class="token string">"--log-opt max-size=50m --log-opt max-file=5"</span>

<span class="token comment" spellcheck="true">## A string of extra options to pass to the docker daemon.</span>
<span class="token comment" spellcheck="true">## This string should be exactly as you wish it to appear.</span>
<span class="token comment" spellcheck="true">## An obvious use case is allowing insecure-registry access</span>
<span class="token comment" spellcheck="true">## to self hosted registries like so:</span>
<span class="token key atrule">docker_options</span><span class="token punctuation">:</span> <span class="token string">"--insecure-registry={{ kube_service_addresses }} --graph={{ docker_daemon_graph }} {{ docker_log_opts }}"</span>

<span class="token comment" spellcheck="true"># Settings for containerized control plane (etcd/kubelet/secrets)</span>
<span class="token key atrule">etcd_deployment_type</span><span class="token punctuation">:</span> docker
<span class="token key atrule">kubelet_deployment_type</span><span class="token punctuation">:</span> docker
<span class="token key atrule">cert_management</span><span class="token punctuation">:</span> script
<span class="token key atrule">vault_deployment_type</span><span class="token punctuation">:</span> docker
<span class="token key atrule">helm_deployment_type</span><span class="token punctuation">:</span> host

<span class="token comment" spellcheck="true"># Enable kubeadm deployment (experimental)</span>
<span class="token key atrule">kubeadm_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">kubeadm_token</span><span class="token punctuation">:</span> <span class="token string">"abcdef.0123456789abcdef"</span>

<span class="token comment" spellcheck="true"># Make a copy of kubeconfig on the host that runs Ansible in GITDIR/artifacts</span>
<span class="token key atrule">kubeconfig_localhost</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token comment" spellcheck="true"># Download kubectl onto the host that runs Ansible in GITDIR/artifacts</span>
<span class="token key atrule">kubectl_localhost</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment" spellcheck="true"># K8s image pull policy (imagePullPolicy)</span>
<span class="token key atrule">k8s_image_pull_policy</span><span class="token punctuation">:</span> IfNotPresent

<span class="token comment" spellcheck="true"># Addons which can be enabled</span>
<span class="token key atrule">efk_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">helm_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">istio_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">enable_network_policy</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">local_volumes_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">persistent_volumes_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment" spellcheck="true"># Base path for local volume provisioner addon</span>
<span class="token key atrule">local_volume_base_dir</span><span class="token punctuation">:</span> /mnt/disks

<span class="token comment" spellcheck="true">## When OpenStack is used, Cinder version can be explicitly specified if autodetection fails (https://github.com/kubernetes/kubernetes/issues/50461)</span>
<span class="token comment" spellcheck="true"># openstack_blockstorage_version: "v1/v2/auto (default)"</span>
<span class="token comment" spellcheck="true">## When OpenStack is used, if LBaaSv2 is available you can enable it with the following variables.</span>
<span class="token key atrule">openstack_lbaas_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token comment" spellcheck="true"># openstack_lbaas_subnet_id: "Neutron subnet ID (not network ID) to create LBaaS VIP"</span>
<span class="token comment" spellcheck="true"># openstack_lbaas_floating_network_id: "Neutron network ID (not subnet ID) to get floating IP from, disabled by default"</span>
<span class="token comment" spellcheck="true"># openstack_lbaas_create_monitor: "yes"</span>
<span class="token comment" spellcheck="true"># openstack_lbaas_monitor_delay: false</span>
<span class="token comment" spellcheck="true"># openstack_lbaas_monitor_timeout: false</span>
<span class="token comment" spellcheck="true"># openstack_lbaas_monitor_max_retries: false</span>

<span class="token comment" spellcheck="true">## List of authorization modes that must be configured for</span>
<span class="token comment" spellcheck="true">## the k8s cluster. Only 'AlwaysAllow', 'AlwaysDeny', 'Node' and</span>
<span class="token comment" spellcheck="true">## 'RBAC' modes are tested. Order is important.</span>
<span class="token key atrule">authorization_modes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Node'</span><span class="token punctuation">,</span> <span class="token string">'RBAC'</span><span class="token punctuation">]</span>
<span class="token key atrule">rbac_enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ 'RBAC' in authorization_modes or kubeadm_enabled }}"</span>

<span class="token comment" spellcheck="true">## List of key=value pairs that describe feature gates for</span>
<span class="token comment" spellcheck="true">## the k8s cluster.</span>
<span class="token key atrule">kube_feature_gates</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Initializers={{ istio_enabled|string }}'</span><span class="token punctuation">,</span> <span class="token string">'PersistentLocalVolumes={{ local_volumes_enabled|string }}'</span><span class="token punctuation">]</span>

<span class="token comment" spellcheck="true"># Vault data dirs.</span>
<span class="token key atrule">vault_base_dir</span><span class="token punctuation">:</span> /etc/vault
<span class="token key atrule">vault_cert_dir</span><span class="token punctuation">:</span> <span class="token string">"{{ vault_base_dir }}/ssl"</span>
<span class="token key atrule">vault_config_dir</span><span class="token punctuation">:</span> <span class="token string">"{{ vault_base_dir }}/config"</span>
<span class="token key atrule">vault_roles_dir</span><span class="token punctuation">:</span> <span class="token string">"{{ vault_base_dir }}/roles"</span>
<span class="token key atrule">vault_secrets_dir</span><span class="token punctuation">:</span> <span class="token string">"{{ vault_base_dir }}/secrets"</span>

<span class="token comment" spellcheck="true">## Set no_proxy to all assigned cluster IPs and hostnames</span>
<span class="token key atrule">no_proxy</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token punctuation">-</span>
  <span class="token punctuation">{</span>%<span class="token punctuation">-</span> if loadbalancer_apiserver is defined <span class="token punctuation">-</span>%<span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span> apiserver_loadbalancer_domain_name<span class="token punctuation">|</span> default('') <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span> loadbalancer_apiserver.address <span class="token punctuation">|</span> default('') <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>%<span class="token punctuation">-</span> endif <span class="token punctuation">-</span>%<span class="token punctuation">}</span>
  <span class="token punctuation">{</span>%<span class="token punctuation">-</span> for item in (groups<span class="token punctuation">[</span><span class="token string">'k8s-cluster'</span><span class="token punctuation">]</span> + groups<span class="token punctuation">[</span><span class="token string">'etcd'</span><span class="token punctuation">]</span> + groups<span class="token punctuation">[</span><span class="token string">'calico-rr'</span><span class="token punctuation">]</span><span class="token punctuation">|</span>default(<span class="token punctuation">[</span><span class="token punctuation">]</span>))<span class="token punctuation">|</span>unique <span class="token punctuation">-</span>%<span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span> hostvars<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'access_ip'</span><span class="token punctuation">]</span> <span class="token punctuation">|</span> default(hostvars<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ip'</span><span class="token punctuation">]</span> <span class="token punctuation">|</span> default(hostvars<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ansible_default_ipv4'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span>)) <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>%<span class="token punctuation">-</span>   if (item <span class="token tag">!=</span> hostvars<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ansible_hostname'</span><span class="token punctuation">]</span>) <span class="token punctuation">-</span>%<span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span> hostvars<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ansible_hostname'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span> hostvars<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ansible_hostname'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>.<span class="token punctuation">{</span><span class="token punctuation">{</span> dns_domain <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>%<span class="token punctuation">-</span>   endif <span class="token punctuation">-</span>%<span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span> item <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">{</span> item <span class="token punctuation">}</span><span class="token punctuation">}</span>.<span class="token punctuation">{</span><span class="token punctuation">{</span> dns_domain <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>%<span class="token punctuation">-</span> endfor <span class="token punctuation">-</span>%<span class="token punctuation">}</span>
  127.0.0.1<span class="token punctuation">,</span>localhost

<span class="token key atrule">proxy_env</span><span class="token punctuation">:</span>
  <span class="token key atrule">http_proxy</span><span class="token punctuation">:</span> <span class="token string">"{{ http_proxy| default ('') }}"</span>
  <span class="token key atrule">https_proxy</span><span class="token punctuation">:</span> <span class="token string">"{{ https_proxy| default ('') }}"</span>
  <span class="token key atrule">no_proxy</span><span class="token punctuation">:</span> <span class="token string">"{{ no_proxy }}"</span>

<span class="token comment" spellcheck="true"># Vars for pointing to kubernetes api endpoints</span>
<span class="token key atrule">is_kube_master</span><span class="token punctuation">:</span> <span class="token string">"{{ inventory_hostname in groups['kube-master'] }}"</span>
<span class="token key atrule">kube_apiserver_count</span><span class="token punctuation">:</span> <span class="token string">"{{ groups['kube-master'] | length }}"</span>
<span class="token key atrule">kube_apiserver_address</span><span class="token punctuation">:</span> <span class="token string">"{{ ip | default(ansible_default_ipv4['address']) }}"</span>
<span class="token key atrule">kube_apiserver_access_address</span><span class="token punctuation">:</span> <span class="token string">"{{ access_ip | default(kube_apiserver_address) }}"</span>
<span class="token key atrule">first_kube_master</span><span class="token punctuation">:</span> <span class="token string">"{{ hostvars[groups['kube-master'][0]]['access_ip'] | default(hostvars[groups['kube-master'][0]]['ip'] | default(hostvars[groups['kube-master'][0]]['ansible_default_ipv4']['address'])) }}"</span>
<span class="token key atrule">loadbalancer_apiserver_localhost</span><span class="token punctuation">:</span> <span class="token string">"{{ loadbalancer_apiserver is not defined }}"</span>
<span class="token comment" spellcheck="true"># applied if only external loadbalancer_apiserver is defined, otherwise ignored</span>
<span class="token key atrule">apiserver_loadbalancer_domain_name</span><span class="token punctuation">:</span> <span class="token string">"lb-apiserver.kubernetes.local"</span>
<span class="token key atrule">kube_apiserver_endpoint</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
  <span class="token punctuation">{</span>% if not is_kube_master and loadbalancer_apiserver_localhost <span class="token punctuation">-</span>%<span class="token punctuation">}</span>
       https<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">{</span> nginx_kube_apiserver_port<span class="token punctuation">|</span>default(kube_apiserver_port) <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span>%<span class="token punctuation">-</span> elif is_kube_master <span class="token punctuation">-</span>%<span class="token punctuation">}</span>
       https<span class="token punctuation">:</span>//<span class="token punctuation">{</span><span class="token punctuation">{</span> kube_apiserver_bind_address <span class="token punctuation">|</span> regex_replace('0\.0\.0\.0'<span class="token punctuation">,</span>'127.0.0.1') <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">{</span> kube_apiserver_port <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span>%<span class="token punctuation">-</span> else <span class="token punctuation">-</span>%<span class="token punctuation">}</span>
  <span class="token punctuation">{</span>%<span class="token punctuation">-</span>   if loadbalancer_apiserver is defined and loadbalancer_apiserver.port is defined <span class="token punctuation">-</span>%<span class="token punctuation">}</span>
       https<span class="token punctuation">:</span>//<span class="token punctuation">{</span><span class="token punctuation">{</span> apiserver_loadbalancer_domain_name<span class="token punctuation">|</span>default('lb<span class="token punctuation">-</span>apiserver.kubernetes.local') <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">{</span> loadbalancer_apiserver.port<span class="token punctuation">|</span>default(kube_apiserver_port) <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span>%<span class="token punctuation">-</span>   else <span class="token punctuation">-</span>%<span class="token punctuation">}</span>
       https<span class="token punctuation">:</span>//<span class="token punctuation">{</span><span class="token punctuation">{</span> first_kube_master <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">{</span> kube_apiserver_port <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span>%<span class="token punctuation">-</span>  endif <span class="token punctuation">-</span>%<span class="token punctuation">}</span>
  <span class="token punctuation">{</span>%<span class="token punctuation">-</span> endif %<span class="token punctuation">}</span>
<span class="token key atrule">kube_apiserver_insecure_endpoint</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token punctuation">-</span>
  http<span class="token punctuation">:</span>//<span class="token punctuation">{</span><span class="token punctuation">{</span> kube_apiserver_insecure_bind_address <span class="token punctuation">|</span> regex_replace('0\.0\.0\.0'<span class="token punctuation">,</span>'127.0.0.1') <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">{</span> kube_apiserver_insecure_port <span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token comment" spellcheck="true"># Vars for pointing to etcd endpoints</span>
<span class="token key atrule">is_etcd_master</span><span class="token punctuation">:</span> <span class="token string">"{{ inventory_hostname in groups['etcd'] }}"</span>
<span class="token key atrule">etcd_address</span><span class="token punctuation">:</span> <span class="token string">"{{ ip | default(ansible_default_ipv4['address']) }}"</span>
<span class="token key atrule">etcd_access_address</span><span class="token punctuation">:</span> <span class="token string">"{{ access_ip | default(etcd_address) }}"</span>
<span class="token key atrule">etcd_peer_url</span><span class="token punctuation">:</span> <span class="token string">"https://{{ etcd_access_address }}:2380"</span>
<span class="token key atrule">etcd_client_url</span><span class="token punctuation">:</span> <span class="token string">"https://{{ etcd_access_address }}:2379"</span>
<span class="token key atrule">etcd_access_addresses</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
  <span class="token punctuation">{</span>% for item in groups<span class="token punctuation">[</span><span class="token string">'etcd'</span><span class="token punctuation">]</span> <span class="token punctuation">-</span>%<span class="token punctuation">}</span>
    https<span class="token punctuation">:</span>//<span class="token punctuation">{</span><span class="token punctuation">{</span> hostvars<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'access_ip'</span><span class="token punctuation">]</span> <span class="token punctuation">|</span> default(hostvars<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ip'</span><span class="token punctuation">]</span> <span class="token punctuation">|</span> default(hostvars<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ansible_default_ipv4'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span>)) <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span>2379<span class="token punctuation">{</span>% if not loop.last %<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>% endif %<span class="token punctuation">}</span>
  <span class="token punctuation">{</span>%<span class="token punctuation">-</span> endfor %<span class="token punctuation">}</span>
<span class="token key atrule">etcd_member_name</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
  <span class="token punctuation">{</span>% for host in groups<span class="token punctuation">[</span><span class="token string">'etcd'</span><span class="token punctuation">]</span> %<span class="token punctuation">}</span>
  <span class="token punctuation">{</span>%   if inventory_hostname == host %<span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span>"etcd"+loop.index<span class="token punctuation">|</span>string <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span>% endif %<span class="token punctuation">}</span>
  <span class="token punctuation">{</span>% endfor %<span class="token punctuation">}</span>
<span class="token key atrule">etcd_peer_addresses</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
  <span class="token punctuation">{</span>% for item in groups<span class="token punctuation">[</span><span class="token string">'etcd'</span><span class="token punctuation">]</span> <span class="token punctuation">-</span>%<span class="token punctuation">}</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span> "etcd"+loop.index<span class="token punctuation">|</span>string <span class="token punctuation">}</span><span class="token punctuation">}</span>=https<span class="token punctuation">:</span>//<span class="token punctuation">{</span><span class="token punctuation">{</span> hostvars<span class="token punctuation">[</span>item<span class="token punctuation">]</span>.access_ip <span class="token punctuation">|</span> default(hostvars<span class="token punctuation">[</span>item<span class="token punctuation">]</span>.ip <span class="token punctuation">|</span> default(hostvars<span class="token punctuation">[</span>item<span class="token punctuation">]</span>.ansible_default_ipv4<span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span>)) <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span>2380<span class="token punctuation">{</span>% if not loop.last %<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>% endif %<span class="token punctuation">}</span>
  <span class="token punctuation">{</span>%<span class="token punctuation">-</span> endfor %<span class="token punctuation">}</span>

</pre>
<p><code>roles/kubespray-defaults/meta/main.yml</code></p>
<pre class="language-yml"><span class="token punctuation">---</span>
<span class="token key atrule">dependencies</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> download
    <span class="token key atrule">skip_downloads</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">tags</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> facts

</pre>
<p><code>roles/kubespray-defaults/tasks/main.yaml</code></p>
<pre class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Configure defaults
  <span class="token key atrule">debug</span><span class="token punctuation">:</span>
    <span class="token key atrule">msg</span><span class="token punctuation">:</span> <span class="token string">"Check roles/kubespray-defaults/defaults/main.yml"</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> always

</pre>
<h6 class="mume-header" id="role-bastion-ssh-config">role: bastion-ssh-config</h6>

<p><code>roles/bastion-ssh-config/tasks/main.yml</code></p>
<pre class="language-yml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">set_fact</span><span class="token punctuation">:</span>
    <span class="token key atrule">has_bastion</span><span class="token punctuation">:</span> <span class="token string">"{{ 'bastion' in groups['all'] }}"</span>

<span class="token punctuation">-</span> <span class="token key atrule">set_fact</span><span class="token punctuation">:</span>
    <span class="token key atrule">bastion_ip</span><span class="token punctuation">:</span> <span class="token string">"{{ hostvars['bastion']['ansible_host'] }}"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span> has_bastion

<span class="token comment" spellcheck="true"># As we are actually running on localhost, the ansible_ssh_user is your local user when you try to use it directly</span>
<span class="token comment" spellcheck="true"># To figure out the real ssh user, we delegate this task to the bastion and store the ansible_user in real_user</span>
<span class="token punctuation">-</span> <span class="token key atrule">set_fact</span><span class="token punctuation">:</span>
    <span class="token key atrule">real_user</span><span class="token punctuation">:</span> <span class="token string">"{{ ansible_user }}"</span>
  <span class="token key atrule">delegate_to</span><span class="token punctuation">:</span> bastion
  <span class="token key atrule">when</span><span class="token punctuation">:</span> has_bastion

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create ssh bastion conf
  <span class="token key atrule">become</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">src</span><span class="token punctuation">:</span> ssh<span class="token punctuation">-</span>bastion.conf
    <span class="token key atrule">dest</span><span class="token punctuation">:</span> <span class="token string">"{{ playbook_dir }}/ssh-bastion.conf"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span> has_bastion

</pre>
<p><code>roles/bastion-ssh-config/templates/ssh-bastion.conf</code></p>
<pre class="language-conf">{% if has_bastion %}
{% set vars={&apos;hosts&apos;: &apos;&apos;} %}
{% set user=&apos;&apos; %}

{% for h in groups[&apos;all&apos;] %}
{% if h != &apos;bastion&apos; %}
{% if vars.update({&apos;hosts&apos;: vars[&apos;hosts&apos;] + &apos; &apos; + (hostvars[h].get(&apos;ansible_ssh_host&apos;) or hostvars[h][&apos;ansible_host&apos;])}) %}{% endif %}
{% endif %}
{% endfor %}

Host {{ bastion_ip }}
  Hostname {{ bastion_ip }}
  StrictHostKeyChecking no
  ControlMaster auto
  ControlPath ~/.ssh/ansible-%r@%h:%p
  ControlPersist 5m

Host {{ vars[&apos;hosts&apos;] }}
  ProxyCommand ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -W %h:%p {{ real_user }}@{{ bastion_ip }} {% if ansible_ssh_private_key_file is defined %}-i {{ ansible_ssh_private_key_file }}{% endif %}
{% endif %}

</pre>
<h6 class="mume-header" id="role-bootstrap-os">role: bootstrap-os</h6>

<pre class="language-yml"><span class="token punctuation">---</span>
<span class="token key atrule">pip_python_coreos_modules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> httplib2
  <span class="token punctuation">-</span> six

</pre>
<pre class="language-sh"><span class="token shebang important">#!/bin/bash</span>
<span class="token keyword">set</span> -e

BINDIR<span class="token operator">=</span><span class="token string">"/opt/bin"</span>

<span class="token function">mkdir</span> -p <span class="token variable">$BINDIR</span>

<span class="token function">cd</span> <span class="token variable">$BINDIR</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -e <span class="token variable">$BINDIR</span>/.bootstrapped <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token keyword">exit</span> 0
<span class="token keyword">fi</span>

PYPY_VERSION<span class="token operator">=</span>5.1.0

<span class="token function">wget</span> -O - https://bitbucket.org/pypy/pypy/downloads/pypy-<span class="token variable">$PYPY_VERSION</span>-linux64.tar.bz2 <span class="token operator">|</span><span class="token function">tar</span> -xjf -
<span class="token function">mv</span> -n pypy-<span class="token variable">$PYPY_VERSION</span>-linux64 pypy

<span class="token comment" spellcheck="true">## library fixup</span>
<span class="token function">mkdir</span> -p pypy/lib
<span class="token function">ln</span> -snf /lib64/libncurses.so.5.9 <span class="token variable">$BINDIR</span>/pypy/lib/libtinfo.so.5

<span class="token function">cat</span> <span class="token operator">></span> <span class="token variable">$BINDIR</span>/python <span class="token operator">&lt;&lt;</span><span class="token string">EOF
#!/bin/bash
LD_LIBRARY_PATH=<span class="token variable">$BINDIR</span>/pypy/lib:<span class="token variable">$LD_LIBRARY_PATH</span> exec <span class="token variable">$BINDIR</span>/pypy/bin/pypy "\<span class="token variable">$@</span>"
EOF</span>

<span class="token function">chmod</span> +x <span class="token variable">$BINDIR</span>/python
<span class="token variable">$BINDIR</span>/python --version

<span class="token function">touch</span> <span class="token variable">$BINDIR</span>/.bootstrapped

</pre>
<p><code>@import &quot;roles/bootstrap-os/files/get-pip.py&quot;</code></p>
<pre class="language-">#!/bin/bash
BINDIR=&quot;/opt/bin&quot;
LD_LIBRARY_PATH=$BINDIR/pypy/lib:$LD_LIBRARY_PATH $BINDIR/pypy/bin/$(basename $0) $@

</pre>
<pre class="language-yml"><span class="token punctuation">---</span>
<span class="token key atrule">pip_python_coreos_modules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> httplib2
  <span class="token punctuation">-</span> six

</pre>
<h6 class="mume-header" id="role-kubernetespreinstall">role: kubernetes/preinstall</h6>

<pre class="language-yml"><span class="token punctuation">---</span>
<span class="token key atrule">run_gitinfos</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment" spellcheck="true"># Set to true to allow pre-checks to fail and continue deployment</span>
<span class="token key atrule">ignore_assert_errors</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token key atrule">epel_rpm_download_url</span><span class="token punctuation">:</span> <span class="token string">"https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm"</span>
<span class="token key atrule">epel_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">common_required_pkgs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> python<span class="token punctuation">-</span>httplib2
  <span class="token punctuation">-</span> openssl
  <span class="token punctuation">-</span> curl
  <span class="token punctuation">-</span> rsync
  <span class="token punctuation">-</span> bash<span class="token punctuation">-</span>completion
  <span class="token punctuation">-</span> socat
  <span class="token punctuation">-</span> unzip

<span class="token comment" spellcheck="true"># Set to true if your network does not support IPv6</span>
<span class="token comment" spellcheck="true"># This maybe necessary for pulling Docker images from</span>
<span class="token comment" spellcheck="true"># GCE docker repository</span>
<span class="token key atrule">disable_ipv6_dns</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token key atrule">kube_cert_group</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>cert
<span class="token key atrule">kube_config_dir</span><span class="token punctuation">:</span> /etc/kubernetes

<span class="token comment" spellcheck="true"># For the openstack integration kubelet will need credentials to access</span>
<span class="token comment" spellcheck="true"># openstack apis like nova and cinder. Per default this values will be</span>
<span class="token comment" spellcheck="true"># read from the environment.</span>
<span class="token key atrule">openstack_auth_url</span><span class="token punctuation">:</span> <span class="token string">"{{ lookup('env','OS_AUTH_URL')  }}"</span>
<span class="token key atrule">openstack_username</span><span class="token punctuation">:</span> <span class="token string">"{{ lookup('env','OS_USERNAME')  }}"</span>
<span class="token key atrule">openstack_password</span><span class="token punctuation">:</span> <span class="token string">"{{ lookup('env','OS_PASSWORD')  }}"</span>
<span class="token key atrule">openstack_region</span><span class="token punctuation">:</span> <span class="token string">"{{ lookup('env','OS_REGION_NAME')  }}"</span>
<span class="token key atrule">openstack_tenant_id</span><span class="token punctuation">:</span> <span class="token string">"{{ lookup('env','OS_TENANT_ID')|default(lookup('env','OS_PROJECT_ID'),true)  }}"</span>
<span class="token key atrule">openstack_domain_name</span><span class="token punctuation">:</span> <span class="token string">"{{ lookup('env','OS_USER_DOMAIN_NAME') }}"</span>
<span class="token key atrule">openstack_domain_id</span><span class="token punctuation">:</span> <span class="token string">"{{ lookup('env','OS_USER_DOMAIN_ID') }}"</span>

<span class="token comment" spellcheck="true"># For the vsphere integration, kubelet will need credentials to access</span>
<span class="token comment" spellcheck="true"># vsphere apis</span>
<span class="token comment" spellcheck="true"># Documentation regarding these values can be found</span>
<span class="token comment" spellcheck="true"># https://github.com/kubernetes/kubernetes/blob/master/pkg/cloudprovider/providers/vsphere/vsphere.go#L105</span>
<span class="token key atrule">vsphere_vcenter_ip</span><span class="token punctuation">:</span> <span class="token string">"{{ lookup('env', 'VSPHERE_VCENTER') }}"</span>
<span class="token key atrule">vsphere_vcenter_port</span><span class="token punctuation">:</span> <span class="token string">"{{ lookup('env', 'VSPHERE_VCENTER_PORT') }}"</span>
<span class="token key atrule">vsphere_user</span><span class="token punctuation">:</span> <span class="token string">"{{ lookup('env', 'VSPHERE_USER') }}"</span>
<span class="token key atrule">vsphere_password</span><span class="token punctuation">:</span> <span class="token string">"{{ lookup('env', 'VSPHERE_PASSWORD') }}"</span>
<span class="token key atrule">vsphere_datacenter</span><span class="token punctuation">:</span> <span class="token string">"{{ lookup('env', 'VSPHERE_DATACENTER') }}"</span>
<span class="token key atrule">vsphere_datastore</span><span class="token punctuation">:</span> <span class="token string">"{{ lookup('env', 'VSPHERE_DATASTORE') }}"</span>
<span class="token key atrule">vsphere_working_dir</span><span class="token punctuation">:</span> <span class="token string">"{{ lookup('env', 'VSPHERE_WORKING_DIR') }}"</span>
<span class="token key atrule">vsphere_insecure</span><span class="token punctuation">:</span> <span class="token string">"{{ lookup('env', 'VSPHERE_INSECURE') }}"</span>
<span class="token key atrule">vsphere_scsi_controller_type</span><span class="token punctuation">:</span> pvscsi
<span class="token comment" spellcheck="true"># vsphere_public_network is name of the network the VMs are joined to</span>
<span class="token key atrule">vsphere_public_network</span><span class="token punctuation">:</span> <span class="token string">"{{ lookup('env', 'VSPHERE_PUBLIC_NETWORK')|default('') }}"</span>

<span class="token comment" spellcheck="true"># Container Linux by CoreOS cloud init config file to define /etc/resolv.conf content</span>
<span class="token comment" spellcheck="true"># for hostnet pods and infra needs</span>
<span class="token key atrule">resolveconf_cloud_init_conf</span><span class="token punctuation">:</span> /etc/resolveconf_cloud_init.conf

<span class="token comment" spellcheck="true"># All inventory hostnames will be written into each /etc/hosts file.</span>
<span class="token key atrule">populate_inventory_to_hosts_file</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">preinstall_selinux_state</span><span class="token punctuation">:</span> permissive

</pre>
<pre class="language-yml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> verify<span class="token punctuation">-</span>settings.yml
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> asserts

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Force binaries directory for Container Linux by CoreOS
  <span class="token key atrule">set_fact</span><span class="token punctuation">:</span>
    <span class="token key atrule">bin_dir</span><span class="token punctuation">:</span> <span class="token string">"/opt/bin"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span> ansible_os_family in <span class="token punctuation">[</span><span class="token string">"CoreOS"</span><span class="token punctuation">,</span> <span class="token string">"Container Linux by CoreOS"</span><span class="token punctuation">]</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> facts

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> check bin dir exists
  <span class="token key atrule">file</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"{{bin_dir}}"</span>
    <span class="token key atrule">state</span><span class="token punctuation">:</span> directory
    <span class="token key atrule">owner</span><span class="token punctuation">:</span> root
  <span class="token key atrule">become</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bootstrap<span class="token punctuation">-</span>os

<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> set_facts.yml
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> facts

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> gather os specific variables
  <span class="token key atrule">include_vars</span><span class="token punctuation">:</span> <span class="token string">"{{ item }}"</span>
  <span class="token key atrule">with_first_found</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">files</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">"{{ ansible_distribution|lower }}-{{ ansible_distribution_version|lower|replace('/', '_') }}.yml"</span>
        <span class="token punctuation">-</span> <span class="token string">"{{ ansible_distribution|lower }}-{{ ansible_distribution_release }}.yml"</span>
        <span class="token punctuation">-</span> <span class="token string">"{{ ansible_distribution|lower }}-{{ ansible_distribution_major_version|lower|replace('/', '_') }}.yml"</span>
        <span class="token punctuation">-</span> <span class="token string">"{{ ansible_distribution|lower }}.yml"</span>
        <span class="token punctuation">-</span> <span class="token string">"{{ ansible_os_family|lower }}.yml"</span>
        <span class="token punctuation">-</span> defaults.yml
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> ../vars
      <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> facts

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Create kubernetes directories
  <span class="token key atrule">file</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"{{ item }}"</span>
    <span class="token key atrule">state</span><span class="token punctuation">:</span> directory
    <span class="token key atrule">owner</span><span class="token punctuation">:</span> kube
  <span class="token key atrule">when</span><span class="token punctuation">:</span> inventory_hostname in groups<span class="token punctuation">[</span><span class="token string">'k8s-cluster'</span><span class="token punctuation">]</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> kubelet
    <span class="token punctuation">-</span> k8s<span class="token punctuation">-</span>secrets
    <span class="token punctuation">-</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
    <span class="token punctuation">-</span> kube<span class="token punctuation">-</span>apiserver
    <span class="token punctuation">-</span> bootstrap<span class="token punctuation">-</span>os
    <span class="token punctuation">-</span> apps
    <span class="token punctuation">-</span> network
    <span class="token punctuation">-</span> master
    <span class="token punctuation">-</span> node
  <span class="token key atrule">with_items</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">"{{ kube_config_dir }}"</span>
    <span class="token punctuation">-</span> <span class="token string">"{{ kube_config_dir }}/ssl"</span>
    <span class="token punctuation">-</span> <span class="token string">"{{ kube_manifest_dir }}"</span>
    <span class="token punctuation">-</span> <span class="token string">"{{ kube_script_dir }}"</span>
    <span class="token punctuation">-</span> <span class="token string">"{{ local_volume_base_dir }}"</span>

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> check cloud_provider value
  <span class="token key atrule">fail</span><span class="token punctuation">:</span>
    <span class="token key atrule">msg</span><span class="token punctuation">:</span> <span class="token string">"If set the 'cloud_provider' var must be set either to 'generic', 'gce', 'aws', 'azure', 'openstack', 'vsphere', or external"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> cloud_provider is defined
    <span class="token punctuation">-</span> cloud_provider not in <span class="token punctuation">[</span><span class="token string">'generic'</span><span class="token punctuation">,</span> <span class="token string">'gce'</span><span class="token punctuation">,</span> <span class="token string">'aws'</span><span class="token punctuation">,</span> <span class="token string">'azure'</span><span class="token punctuation">,</span> <span class="token string">'openstack'</span><span class="token punctuation">,</span> <span class="token string">'vsphere'</span><span class="token punctuation">,</span> <span class="token string">'external'</span><span class="token punctuation">]</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> cloud<span class="token punctuation">-</span>provider
    <span class="token punctuation">-</span> facts

<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">"{{ cloud_provider }}-credential-check.yml"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> cloud_provider is defined
    <span class="token punctuation">-</span> cloud_provider in <span class="token punctuation">[</span> <span class="token string">'openstack'</span><span class="token punctuation">,</span> <span class="token string">'azure'</span><span class="token punctuation">,</span> <span class="token string">'vsphere'</span> <span class="token punctuation">]</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> cloud<span class="token punctuation">-</span>provider
    <span class="token punctuation">-</span> facts

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Create cni directories
  <span class="token key atrule">file</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"{{ item }}"</span>
    <span class="token key atrule">state</span><span class="token punctuation">:</span> directory
    <span class="token key atrule">owner</span><span class="token punctuation">:</span> kube
  <span class="token key atrule">with_items</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">"/etc/cni/net.d"</span>
    <span class="token punctuation">-</span> <span class="token string">"/opt/cni/bin"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> kube_network_plugin in <span class="token punctuation">[</span><span class="token string">"calico"</span><span class="token punctuation">,</span> <span class="token string">"weave"</span><span class="token punctuation">,</span> <span class="token string">"canal"</span><span class="token punctuation">,</span> <span class="token string">"flannel"</span><span class="token punctuation">,</span> <span class="token string">"contiv"</span><span class="token punctuation">]</span>
    <span class="token punctuation">-</span> inventory_hostname in groups<span class="token punctuation">[</span><span class="token string">'k8s-cluster'</span><span class="token punctuation">]</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> network
    <span class="token punctuation">-</span> calico
    <span class="token punctuation">-</span> weave
    <span class="token punctuation">-</span> canal
    <span class="token punctuation">-</span> contiv
    <span class="token punctuation">-</span> bootstrap<span class="token punctuation">-</span>os

<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> resolvconf.yml
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> dns_mode <span class="token tag">!=</span> 'none'
    <span class="token punctuation">-</span> resolvconf_mode == 'host_resolvconf'
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bootstrap<span class="token punctuation">-</span>os
    <span class="token punctuation">-</span> resolvconf

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Update package management cache (YUM)
  <span class="token key atrule">yum</span><span class="token punctuation">:</span>
    <span class="token key atrule">update_cache</span><span class="token punctuation">:</span> yes
    <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'*'</span>
  <span class="token key atrule">register</span><span class="token punctuation">:</span> yum_task_result
  <span class="token key atrule">until</span><span class="token punctuation">:</span> yum_task_result<span class="token punctuation">|</span>succeeded
  <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">4</span>
  <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token string">"{{ retry_stagger | random + 3 }}"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ansible_pkg_mgr == 'yum'
    <span class="token punctuation">-</span> ansible_distribution <span class="token tag">!=</span> 'RedHat'
    <span class="token punctuation">-</span> not is_atomic
  <span class="token key atrule">tags</span><span class="token punctuation">:</span> bootstrap<span class="token punctuation">-</span>os

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Expire management cache (YUM) for Updation <span class="token punctuation">-</span> Redhat
  <span class="token key atrule">shell</span><span class="token punctuation">:</span> yum clean expire<span class="token punctuation">-</span>cache
  <span class="token key atrule">register</span><span class="token punctuation">:</span> expire_cache_output
  <span class="token key atrule">until</span><span class="token punctuation">:</span> expire_cache_output<span class="token punctuation">|</span>succeeded
  <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">4</span>
  <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token string">"{{ retry_stagger | random + 3 }}"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ansible_pkg_mgr == 'yum'
    <span class="token punctuation">-</span> ansible_distribution == 'RedHat'
    <span class="token punctuation">-</span> not is_atomic
  <span class="token key atrule">tags</span><span class="token punctuation">:</span> bootstrap<span class="token punctuation">-</span>os

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Update package management cache (YUM) <span class="token punctuation">-</span> Redhat
  <span class="token key atrule">shell</span><span class="token punctuation">:</span> yum makecache
  <span class="token key atrule">register</span><span class="token punctuation">:</span> make_cache_output
  <span class="token key atrule">until</span><span class="token punctuation">:</span> make_cache_output<span class="token punctuation">|</span>succeeded
  <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">4</span>
  <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token string">"{{ retry_stagger | random + 3 }}"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ansible_pkg_mgr == 'yum'
    <span class="token punctuation">-</span> ansible_distribution == 'RedHat'
    <span class="token punctuation">-</span> expire_cache_output.rc == 0
    <span class="token punctuation">-</span> not is_atomic
  <span class="token key atrule">tags</span><span class="token punctuation">:</span> bootstrap<span class="token punctuation">-</span>os


<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install latest version of python<span class="token punctuation">-</span>apt for Debian distribs
  <span class="token key atrule">apt</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> python<span class="token punctuation">-</span>apt
    <span class="token key atrule">state</span><span class="token punctuation">:</span> latest
    <span class="token key atrule">update_cache</span><span class="token punctuation">:</span> yes
    <span class="token key atrule">cache_valid_time</span><span class="token punctuation">:</span> <span class="token number">3600</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span> ansible_os_family == "Debian"
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bootstrap<span class="token punctuation">-</span>os

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install python<span class="token punctuation">-</span>dnf for latest RedHat versions
  <span class="token key atrule">command</span><span class="token punctuation">:</span> dnf install <span class="token punctuation">-</span>y python<span class="token punctuation">-</span>dnf yum
  <span class="token key atrule">register</span><span class="token punctuation">:</span> dnf_task_result
  <span class="token key atrule">until</span><span class="token punctuation">:</span> dnf_task_result<span class="token punctuation">|</span>succeeded
  <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">4</span>
  <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token string">"{{ retry_stagger | random + 3 }}"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ansible_distribution == "Fedora"
    <span class="token punctuation">-</span> ansible_distribution_major_version <span class="token punctuation">></span> 21
    <span class="token punctuation">-</span> not is_atomic
  <span class="token key atrule">changed_when</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bootstrap<span class="token punctuation">-</span>os

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install epel<span class="token punctuation">-</span>release on RedHat/CentOS
  <span class="token key atrule">shell</span><span class="token punctuation">:</span> rpm <span class="token punctuation">-</span>qa <span class="token punctuation">|</span> grep epel<span class="token punctuation">-</span>release <span class="token punctuation">|</span><span class="token punctuation">|</span> rpm <span class="token punctuation">-</span>ivh <span class="token punctuation">{</span><span class="token punctuation">{</span> epel_rpm_download_url <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">register</span><span class="token punctuation">:</span> epel_task_result
  <span class="token key atrule">until</span><span class="token punctuation">:</span> epel_task_result<span class="token punctuation">|</span>succeeded
  <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">4</span>
  <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token string">"{{ retry_stagger | random + 3 }}"</span>
  <span class="token key atrule">changed_when</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ansible_distribution in <span class="token punctuation">[</span><span class="token string">"CentOS"</span><span class="token punctuation">,</span><span class="token string">"RedHat"</span><span class="token punctuation">]</span>
    <span class="token punctuation">-</span> not is_atomic
    <span class="token punctuation">-</span> epel_rpm_download_url <span class="token tag">!=</span> ''
    <span class="token punctuation">-</span> epel_enabled<span class="token punctuation">|</span>bool
  <span class="token key atrule">check_mode</span><span class="token punctuation">:</span> no
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bootstrap<span class="token punctuation">-</span>os

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install packages requirements
  <span class="token key atrule">action</span><span class="token punctuation">:</span>
    <span class="token key atrule">module</span><span class="token punctuation">:</span> <span class="token string">"{{ ansible_pkg_mgr }}"</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"{{ item }}"</span>
    <span class="token key atrule">state</span><span class="token punctuation">:</span> latest
  <span class="token key atrule">register</span><span class="token punctuation">:</span> pkgs_task_result
  <span class="token key atrule">until</span><span class="token punctuation">:</span> pkgs_task_result<span class="token punctuation">|</span>succeeded
  <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">4</span>
  <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token string">"{{ retry_stagger | random + 3 }}"</span>
  <span class="token key atrule">with_items</span><span class="token punctuation">:</span> <span class="token string">"{{required_pkgs | default([]) | union(common_required_pkgs|default([]))}}"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span> not (ansible_os_family in <span class="token punctuation">[</span><span class="token string">"CoreOS"</span><span class="token punctuation">,</span> <span class="token string">"Container Linux by CoreOS"</span><span class="token punctuation">]</span> or is_atomic)
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bootstrap<span class="token punctuation">-</span>os

<span class="token comment" spellcheck="true"># Todo : selinux configuration</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Confirm selinux deployed
  <span class="token key atrule">stat</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/selinux/config
  <span class="token key atrule">when</span><span class="token punctuation">:</span> ansible_os_family == "RedHat"
  <span class="token key atrule">register</span><span class="token punctuation">:</span> slc

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set selinux policy
  <span class="token key atrule">selinux</span><span class="token punctuation">:</span>
    <span class="token key atrule">policy</span><span class="token punctuation">:</span> targeted
    <span class="token key atrule">state</span><span class="token punctuation">:</span> <span class="token string">"{{ preinstall_selinux_state }}"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ansible_os_family == "RedHat"
    <span class="token punctuation">-</span> slc.stat.exists == True
  <span class="token key atrule">changed_when</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bootstrap<span class="token punctuation">-</span>os

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Disable IPv6 DNS lookup
  <span class="token key atrule">lineinfile</span><span class="token punctuation">:</span>
    <span class="token key atrule">dest</span><span class="token punctuation">:</span> /etc/gai.conf
    <span class="token key atrule">line</span><span class="token punctuation">:</span> <span class="token string">"precedence ::ffff:0:0/96  100"</span>
    <span class="token key atrule">state</span><span class="token punctuation">:</span> present
    <span class="token key atrule">backup</span><span class="token punctuation">:</span> yes
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> disable_ipv6_dns
    <span class="token punctuation">-</span> not ansible_os_family in <span class="token punctuation">[</span><span class="token string">"CoreOS"</span><span class="token punctuation">,</span> <span class="token string">"Container Linux by CoreOS"</span><span class="token punctuation">]</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bootstrap<span class="token punctuation">-</span>os

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> set default sysctl file path
  <span class="token key atrule">set_fact</span><span class="token punctuation">:</span>
    <span class="token key atrule">sysctl_file_path</span><span class="token punctuation">:</span> <span class="token string">"/etc/sysctl.d/99-sysctl.conf"</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bootstrap<span class="token punctuation">-</span>os

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Stat sysctl file configuration
  <span class="token key atrule">stat</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"{{sysctl_file_path}}"</span>
  <span class="token key atrule">register</span><span class="token punctuation">:</span> sysctl_file_stat
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bootstrap<span class="token punctuation">-</span>os

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Change sysctl file path to link source if linked
  <span class="token key atrule">set_fact</span><span class="token punctuation">:</span>
    <span class="token key atrule">sysctl_file_path</span><span class="token punctuation">:</span> <span class="token string">"{{sysctl_file_stat.stat.lnk_source}}"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> sysctl_file_stat.stat.islnk is defined
    <span class="token punctuation">-</span> sysctl_file_stat.stat.islnk
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bootstrap<span class="token punctuation">-</span>os

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Enable ip forwarding
  <span class="token key atrule">sysctl</span><span class="token punctuation">:</span>
    <span class="token key atrule">sysctl_file</span><span class="token punctuation">:</span> <span class="token string">"{{sysctl_file_path}}"</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> net.ipv4.ip_forward
    <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">state</span><span class="token punctuation">:</span> present
    <span class="token key atrule">reload</span><span class="token punctuation">:</span> yes
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bootstrap<span class="token punctuation">-</span>os

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Write cloud<span class="token punctuation">-</span>config
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">src</span><span class="token punctuation">:</span> <span class="token string">"{{ cloud_provider }}-cloud-config.j2"</span>
    <span class="token key atrule">dest</span><span class="token punctuation">:</span> <span class="token string">"{{ kube_config_dir }}/cloud_config"</span>
    <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">"{{ kube_cert_group }}"</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token number">0640</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> inventory_hostname in groups<span class="token punctuation">[</span><span class="token string">'k8s-cluster'</span><span class="token punctuation">]</span>
    <span class="token punctuation">-</span> cloud_provider is defined
    <span class="token punctuation">-</span> cloud_provider in <span class="token punctuation">[</span> <span class="token string">'openstack'</span><span class="token punctuation">,</span> <span class="token string">'azure'</span><span class="token punctuation">,</span> <span class="token string">'vsphere'</span> <span class="token punctuation">]</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> cloud<span class="token punctuation">-</span>provider

<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> etchosts.yml
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bootstrap<span class="token punctuation">-</span>os
    <span class="token punctuation">-</span> etchosts

<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> dhclient<span class="token punctuation">-</span>hooks.yml
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> dns_mode <span class="token tag">!=</span> 'none'
    <span class="token punctuation">-</span> resolvconf_mode == 'host_resolvconf'
    <span class="token punctuation">-</span> not ansible_os_family in <span class="token punctuation">[</span><span class="token string">"CoreOS"</span><span class="token punctuation">,</span> <span class="token string">"Container Linux by CoreOS"</span><span class="token punctuation">]</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bootstrap<span class="token punctuation">-</span>os
    <span class="token punctuation">-</span> resolvconf

<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> dhclient<span class="token punctuation">-</span>hooks<span class="token punctuation">-</span>undo.yml
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> dns_mode <span class="token tag">!=</span> 'none'
    <span class="token punctuation">-</span> resolvconf_mode <span class="token tag">!=</span> 'host_resolvconf'
    <span class="token punctuation">-</span> not ansible_os_family in <span class="token punctuation">[</span><span class="token string">"CoreOS"</span><span class="token punctuation">,</span> <span class="token string">"Container Linux by CoreOS"</span><span class="token punctuation">]</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bootstrap<span class="token punctuation">-</span>os
    <span class="token punctuation">-</span> resolvconf

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Check if we are running inside a Azure VM
  <span class="token key atrule">stat</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/lib/waagent/
  <span class="token key atrule">register</span><span class="token punctuation">:</span> azure_check
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bootstrap<span class="token punctuation">-</span>os

<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> growpart<span class="token punctuation">-</span>azure<span class="token punctuation">-</span>centos<span class="token punctuation">-</span>7.yml
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> azure_check.stat.exists
    <span class="token punctuation">-</span> ansible_distribution in <span class="token punctuation">[</span><span class="token string">"CentOS"</span><span class="token punctuation">,</span><span class="token string">"RedHat"</span><span class="token punctuation">]</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bootstrap<span class="token punctuation">-</span>os

</pre>
<h6 class="mume-header" id="role-download">role: download</h6>

<p><code>roles/download/defaults/main.yml</code></p>
<pre class="language-yml"><span class="token punctuation">---</span>
<span class="token key atrule">local_release_dir</span><span class="token punctuation">:</span> /tmp

<span class="token comment" spellcheck="true"># Used to only evaluate vars from download role</span>
<span class="token key atrule">skip_downloads</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment" spellcheck="true"># if this is set to true will only download files once. Doesn't work</span>
<span class="token comment" spellcheck="true"># on Container Linux by CoreOS unless the download_localhost is true and localhost</span>
<span class="token comment" spellcheck="true"># is running another OS type. Default compress level is 1 (fastest).</span>
<span class="token key atrule">download_run_once</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
<span class="token key atrule">download_compress</span><span class="token punctuation">:</span> <span class="token number">1</span>

<span class="token comment" spellcheck="true"># if this is set to true, uses the localhost for download_run_once mode</span>
<span class="token comment" spellcheck="true"># (requires docker and sudo to access docker). You may want this option for</span>
<span class="token comment" spellcheck="true"># local caching of docker images or for Container Linux by CoreOS cluster nodes.</span>
<span class="token comment" spellcheck="true"># Otherwise, uses the first node in the kube-master group to store images</span>
<span class="token comment" spellcheck="true"># in the download_run_once mode.</span>
<span class="token key atrule">download_localhost</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>

<span class="token comment" spellcheck="true"># Always pull images if set to True. Otherwise check by the repo's tag/digest.</span>
<span class="token key atrule">download_always_pull</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>

<span class="token comment" spellcheck="true"># Use the first kube-master if download_localhost is not set</span>
<span class="token key atrule">download_delegate</span><span class="token punctuation">:</span> <span class="token string">"{% if download_localhost %}localhost{% else %}{{groups['kube-master'][0]}}{% endif %}"</span>

<span class="token comment" spellcheck="true"># Versions</span>
<span class="token key atrule">kube_version</span><span class="token punctuation">:</span> v1.9.0
<span class="token key atrule">kubeadm_version</span><span class="token punctuation">:</span> <span class="token string">"{{ kube_version }}"</span>
<span class="token key atrule">etcd_version</span><span class="token punctuation">:</span> v3.2.4
<span class="token comment" spellcheck="true"># TODO(mattymo): Move calico versions to roles/network_plugins/calico/defaults</span>
<span class="token comment" spellcheck="true"># after migration to container download</span>
<span class="token key atrule">calico_version</span><span class="token punctuation">:</span> <span class="token string">"v2.6.2"</span>
<span class="token key atrule">calico_ctl_version</span><span class="token punctuation">:</span> <span class="token string">"v1.6.1"</span>
<span class="token key atrule">calico_cni_version</span><span class="token punctuation">:</span> <span class="token string">"v1.11.0"</span>
<span class="token key atrule">calico_policy_version</span><span class="token punctuation">:</span> <span class="token string">"v1.0.0"</span>
<span class="token key atrule">calico_rr_version</span><span class="token punctuation">:</span> <span class="token string">"v0.4.0"</span>
<span class="token key atrule">flannel_version</span><span class="token punctuation">:</span> <span class="token string">"v0.9.1-amd64"</span>
<span class="token key atrule">flannel_cni_version</span><span class="token punctuation">:</span> <span class="token string">"v0.3.0"</span>
<span class="token key atrule">istio_version</span><span class="token punctuation">:</span> <span class="token string">"0.2.6"</span>
<span class="token key atrule">vault_version</span><span class="token punctuation">:</span> 0.8.1
<span class="token key atrule">weave_version</span><span class="token punctuation">:</span> 2.0.5
<span class="token key atrule">pod_infra_version</span><span class="token punctuation">:</span> <span class="token number">3.0</span>
<span class="token key atrule">contiv_version</span><span class="token punctuation">:</span> 1.1.7

<span class="token comment" spellcheck="true"># Download URLs</span>
<span class="token key atrule">istioctl_download_url</span><span class="token punctuation">:</span> <span class="token string">"https://storage.googleapis.com/istio-release/releases/{{ istio_version }}/istioctl/istioctl-linux"</span>
<span class="token key atrule">kubeadm_download_url</span><span class="token punctuation">:</span> <span class="token string">"https://storage.googleapis.com/kubernetes-release/release/{{ kubeadm_version }}/bin/linux/amd64/kubeadm"</span>
<span class="token key atrule">vault_download_url</span><span class="token punctuation">:</span> <span class="token string">"https://releases.hashicorp.com/vault/{{ vault_version }}/vault_{{ vault_version }}_linux_amd64.zip"</span>

<span class="token comment" spellcheck="true"># Checksums</span>
<span class="token key atrule">istioctl_checksum</span><span class="token punctuation">:</span> fd703063c540b8c0ab943f478c05ab257d88ae27224c746a27d0526ddbf7c370
<span class="token key atrule">kubeadm_checksum</span><span class="token punctuation">:</span> 069e386f620e7274e114226ab7532c2320be7f65328c1e55b23a69b73122b828
<span class="token key atrule">vault_binary_checksum</span><span class="token punctuation">:</span> 3c4d70ba71619a43229e65c67830e30e050eab7a81ac6b28325ff707e5914188

<span class="token comment" spellcheck="true"># Containers</span>
<span class="token comment" spellcheck="true">#etcd_image_repo: "quay.io/coreos/etcd"</span>
<span class="token key atrule">etcd_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-shenzhen.aliyuncs.com/bixin_quay_io/coreos-etcd"</span>
<span class="token key atrule">etcd_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ etcd_version }}"</span>
<span class="token comment" spellcheck="true">#flannel_image_repo: "quay.io/coreos/flannel"</span>
<span class="token key atrule">flannel_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-hangzhou.aliyuncs.com/szss_quay_io/coreos-flannel"</span>
<span class="token key atrule">flannel_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ flannel_version }}"</span>
<span class="token comment" spellcheck="true">#flannel_cni_image_repo: "quay.io/coreos/flannel-cni"</span>
<span class="token key atrule">flannel_cni_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-beijing.aliyuncs.com/bbt-kube/flannel-cni"</span>
<span class="token key atrule">flannel_cni_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ flannel_cni_version }}"</span>
<span class="token comment" spellcheck="true">#calicoctl_image_repo: "quay.io/calico/ctl"</span>
<span class="token key atrule">calicoctl_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-hangzhou.aliyuncs.com/liuq/calico-ctl"</span>
<span class="token key atrule">calicoctl_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ calico_ctl_version }}"</span>
<span class="token comment" spellcheck="true">#calico_node_image_repo: "quay.io/calico/node"</span>
<span class="token key atrule">calico_node_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-hangzhou.aliyuncs.com/calico_containers/node"</span>
<span class="token key atrule">calico_node_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ calico_version }}"</span>
<span class="token comment" spellcheck="true">#calico_cni_image_repo: "quay.io/calico/cni"</span>
<span class="token key atrule">calico_cni_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-hangzhou.aliyuncs.com/calico_containers/cni"</span>
<span class="token key atrule">calico_cni_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ calico_cni_version }}"</span>
<span class="token comment" spellcheck="true">#calico_policy_image_repo: "quay.io/calico/kube-controllers"</span>
<span class="token key atrule">calico_policy_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-hangzhou.aliyuncs.com/calico_containers/kube-controllers"</span>
<span class="token key atrule">calico_policy_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ calico_policy_version }}"</span>
<span class="token comment" spellcheck="true">#calico_rr_image_repo: "quay.io/calico/routereflector"</span>
<span class="token key atrule">calico_rr_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-hangzhou.aliyuncs.com/szss_quay_io/calico-routereflector"</span>
<span class="token key atrule">calico_rr_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ calico_rr_version }}"</span>
<span class="token comment" spellcheck="true">#hyperkube_image_repo: "quay.io/coreos/hyperkube"</span>
<span class="token key atrule">hyperkube_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-hangzhou.aliyuncs.com/kubernetes-images/hyperkube"</span>
<span class="token key atrule">hyperkube_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ kube_version }}_coreos.0"</span>
<span class="token comment" spellcheck="true">#pod_infra_image_repo: "gcr.io/google_containers/pause-amd64"</span>
<span class="token key atrule">pod_infra_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64"</span>
<span class="token key atrule">pod_infra_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ pod_infra_version }}"</span>
<span class="token comment" spellcheck="true">#install_socat_image_repo: "xueshanf/install-socat"</span>
<span class="token key atrule">install_socat_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-shanghai.aliyuncs.com/ly_ops/install-socat"</span>
<span class="token key atrule">install_socat_image_tag</span><span class="token punctuation">:</span> <span class="token string">"latest"</span>
<span class="token key atrule">netcheck_version</span><span class="token punctuation">:</span> <span class="token string">"v1.0"</span>
<span class="token comment" spellcheck="true">#netcheck_agent_img_repo: "quay.io/l23network/k8s-netchecker-agent"</span>
<span class="token key atrule">netcheck_agent_img_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-hangzhou.aliyuncs.com/kargo/l23network_k8s-netchecker-agent"</span>
<span class="token key atrule">netcheck_agent_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ netcheck_version }}"</span>
<span class="token comment" spellcheck="true">#netcheck_server_img_repo: "quay.io/l23network/k8s-netchecker-server"</span>
<span class="token key atrule">netcheck_server_img_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-hangzhou.aliyuncs.com/kargo/l23network_k8s-netchecker-server"</span>
<span class="token key atrule">netcheck_server_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ netcheck_version }}"</span>
<span class="token comment" spellcheck="true">#weave_kube_image_repo: "weaveworks/weave-kube"</span>
<span class="token key atrule">weave_kube_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-shanghai.aliyuncs.com/ly_ops/weave-kube"</span>
<span class="token key atrule">weave_kube_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ weave_version }}"</span>
<span class="token comment" spellcheck="true">#weave_npc_image_repo: "weaveworks/weave-npc"</span>
<span class="token key atrule">weave_npc_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-shanghai.aliyuncs.com/ly_ops/weave-npc"</span>
<span class="token key atrule">weave_npc_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ weave_version }}"</span>
<span class="token comment" spellcheck="true">#contiv_image_repo: "contiv/netplugin"</span>
<span class="token key atrule">contiv_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-shanghai.aliyuncs.com/ly_ops/netplugin"</span>
<span class="token key atrule">contiv_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ contiv_version }}"</span>
<span class="token comment" spellcheck="true">#contiv_auth_proxy_image_repo: "contiv/auth_proxy"</span>
<span class="token key atrule">contiv_auth_proxy_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-shanghai.aliyuncs.com/ly_ops/auth_proxy"</span>
<span class="token key atrule">contiv_auth_proxy_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ contiv_version }}"</span>

<span class="token key atrule">nginx_image_repo</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">nginx_image_tag</span><span class="token punctuation">:</span> <span class="token number">1.13</span>
<span class="token key atrule">dnsmasq_version</span><span class="token punctuation">:</span> <span class="token number">2.78</span>
<span class="token comment" spellcheck="true">#dnsmasq_image_repo: "andyshinn/dnsmasq"</span>
<span class="token key atrule">dnsmasq_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-beijing.aliyuncs.com/iamwlb/dnsmasq"</span>
<span class="token key atrule">dnsmasq_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ dnsmasq_version }}"</span>
<span class="token key atrule">kubedns_version</span><span class="token punctuation">:</span> 1.14.7
<span class="token comment" spellcheck="true">#kubedns_image_repo: "gcr.io/google_containers/k8s-dns-kube-dns-amd64"</span>
<span class="token key atrule">kubedns_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-hangzhou.aliyuncs.com/google_containers/k8s-dns-kube-dns-amd64"</span>
<span class="token key atrule">kubedns_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ kubedns_version }}"</span>
<span class="token comment" spellcheck="true">#dnsmasq_nanny_image_repo: "gcr.io/google_containers/k8s-dns-dnsmasq-nanny-amd64"</span>
<span class="token key atrule">dnsmasq_nanny_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-hangzhou.aliyuncs.com/google_containers/k8s-dns-dnsmasq-nanny-amd64"</span>
<span class="token key atrule">dnsmasq_nanny_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ kubedns_version }}"</span>
<span class="token comment" spellcheck="true">#dnsmasq_sidecar_image_repo: "gcr.io/google_containers/k8s-dns-sidecar-amd64"</span>
<span class="token key atrule">dnsmasq_sidecar_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-hangzhou.aliyuncs.com/google_containers/k8s-dns-sidecar-amd64"</span>
<span class="token key atrule">dnsmasq_sidecar_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ kubedns_version }}"</span>
<span class="token key atrule">kubednsautoscaler_version</span><span class="token punctuation">:</span> 1.1.1
<span class="token comment" spellcheck="true">#kubednsautoscaler_image_repo: "gcr.io/google_containers/cluster-proportional-autoscaler-amd64"</span>
<span class="token key atrule">kubednsautoscaler_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-hangzhou.aliyuncs.com/kargo/google_containers_cluster-proportional-autoscaler-amd64"</span>
<span class="token key atrule">kubednsautoscaler_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ kubednsautoscaler_version }}"</span>
<span class="token key atrule">test_image_repo</span><span class="token punctuation">:</span> busybox
<span class="token key atrule">test_image_tag</span><span class="token punctuation">:</span> latest
<span class="token key atrule">elasticsearch_version</span><span class="token punctuation">:</span> <span class="token string">"v2.4.1"</span>
<span class="token comment" spellcheck="true">#elasticsearch_image_repo: "gcr.io/google_containers/elasticsearch"</span>
<span class="token key atrule">elasticsearch_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-hangzhou.aliyuncs.com/kargo/google_containers_elasticsearch"</span>
<span class="token key atrule">elasticsearch_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ elasticsearch_version }}"</span>
<span class="token key atrule">fluentd_version</span><span class="token punctuation">:</span> <span class="token string">"1.22"</span>
<span class="token comment" spellcheck="true">#fluentd_image_repo: "gcr.io/google_containers/fluentd-elasticsearch"</span>
<span class="token key atrule">fluentd_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-hangzhou.aliyuncs.com/google_images/fluentd-elasticsearch"</span>
<span class="token key atrule">fluentd_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ fluentd_version }}"</span>
<span class="token key atrule">kibana_version</span><span class="token punctuation">:</span> <span class="token string">"v4.6.1"</span>
<span class="token comment" spellcheck="true">#kibana_image_repo: "gcr.io/google_containers/kibana"</span>
<span class="token key atrule">kibana_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-hangzhou.aliyuncs.com/kargo/google_containers_kibana"</span>
<span class="token key atrule">kibana_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ kibana_version }}"</span>

<span class="token key atrule">helm_version</span><span class="token punctuation">:</span> <span class="token string">"v2.7.2"</span>
<span class="token comment" spellcheck="true">#helm_image_repo: "lachlanevenson/k8s-helm"</span>
<span class="token key atrule">helm_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-shanghai.aliyuncs.com/ly_ops/k8s-helm"</span>
<span class="token key atrule">helm_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ helm_version }}"</span>
<span class="token comment" spellcheck="true">#tiller_image_repo: "gcr.io/kubernetes-helm/tiller"</span>
<span class="token key atrule">tiller_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-beijing.aliyuncs.com/my-img/tiller"</span>
<span class="token key atrule">tiller_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ helm_version }}"</span>
<span class="token comment" spellcheck="true">#vault_image_repo: "vault"</span>
<span class="token key atrule">vault_image_repo</span><span class="token punctuation">:</span> <span class="token string">"registry.cn-shanghai.aliyuncs.com/ly_ops/vault"</span>
<span class="token key atrule">vault_image_tag</span><span class="token punctuation">:</span> <span class="token string">"{{ vault_version }}"</span>

<span class="token key atrule">downloads</span><span class="token punctuation">:</span>
  <span class="token key atrule">netcheck_server</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ deploy_netchecker }}"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ netcheck_server_img_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ netcheck_server_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ netcheck_server_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">netcheck_agent</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ deploy_netchecker }}"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ netcheck_agent_img_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ netcheck_agent_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ netcheck_agent_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">etcd</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ etcd_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ etcd_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ etcd_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">kubeadm</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ kubeadm_enabled }}"</span>
    <span class="token key atrule">file</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"{{ kubeadm_version }}"</span>
    <span class="token key atrule">dest</span><span class="token punctuation">:</span> <span class="token string">"kubeadm"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ kubeadm_checksum }}"</span>
    <span class="token key atrule">source_url</span><span class="token punctuation">:</span> <span class="token string">"{{ kubeadm_download_url }}"</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"{{ kubeadm_download_url }}"</span>
    <span class="token key atrule">unarchive</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">owner</span><span class="token punctuation">:</span> <span class="token string">"root"</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token string">"0755"</span>
  <span class="token key atrule">istioctl</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ istio_enabled }}"</span>
    <span class="token key atrule">file</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"{{ istio_version }}"</span>
    <span class="token key atrule">dest</span><span class="token punctuation">:</span> <span class="token string">"istio/istioctl"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ istioctl_checksum }}"</span>
    <span class="token key atrule">source_url</span><span class="token punctuation">:</span> <span class="token string">"{{ istioctl_download_url }}"</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"{{ istioctl_download_url }}"</span>
    <span class="token key atrule">unarchive</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">owner</span><span class="token punctuation">:</span> <span class="token string">"root"</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token string">"0755"</span>
  <span class="token key atrule">hyperkube</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ hyperkube_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ hyperkube_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ hyperkube_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">flannel</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ kube_network_plugin == 'flannel' or kube_network_plugin == 'canal' }}"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ flannel_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ flannel_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ flannel_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">flannel_cni</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ kube_network_plugin == 'flannel' }}"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ flannel_cni_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ flannel_cni_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ flannel_cni_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">calicoctl</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ kube_network_plugin == 'calico' or kube_network_plugin == 'canal' }}"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ calicoctl_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ calicoctl_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ calicoctl_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">calico_node</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ kube_network_plugin == 'calico' or kube_network_plugin == 'canal' }}"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ calico_node_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ calico_node_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ calico_node_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">calico_cni</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ kube_network_plugin == 'calico' or kube_network_plugin == 'canal' }}"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ calico_cni_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ calico_cni_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ calico_cni_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">calico_policy</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ enable_network_policy or kube_network_plugin == 'canal' }}"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ calico_policy_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ calico_policy_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ calico_policy_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">calico_rr</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ peer_with_calico_rr is defined and peer_with_calico_rr}} and kube_network_plugin == 'calico'"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ calico_rr_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ calico_rr_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ calico_rr_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">weave_kube</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ kube_network_plugin == 'weave' }}"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ weave_kube_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ weave_kube_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ weave_kube_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">weave_npc</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ kube_network_plugin == 'weave' }}"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ weave_npc_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ weave_npc_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ weave_npc_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">contiv</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ kube_network_plugin == 'contiv' }}"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ contiv_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ contiv_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ contiv_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">contiv_auth_proxy</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ kube_network_plugin == 'contiv' }}"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ contiv_auth_proxy_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ contiv_auth_proxy_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ contiv_auth_proxy_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">pod_infra</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ pod_infra_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ pod_infra_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ pod_infra_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">install_socat</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ ansible_os_family in ['CoreOS', 'Container Linux by CoreOS'] }}"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ install_socat_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ install_socat_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ install_socat_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">nginx</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ nginx_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ nginx_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ nginx_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">dnsmasq</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ dns_mode == 'dnsmasq_kubedns' }}"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ dnsmasq_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ dnsmasq_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ dnsmasq_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">kubedns</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ kubedns_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ kubedns_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ kubedns_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">dnsmasq_nanny</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ dnsmasq_nanny_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ dnsmasq_nanny_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ dnsmasq_nanny_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">dnsmasq_sidecar</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ dnsmasq_sidecar_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ dnsmasq_sidecar_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ dnsmasq_sidecar_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">kubednsautoscaler</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ kubednsautoscaler_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ kubednsautoscaler_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ kubednsautoscaler_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">testbox</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ test_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ test_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ testbox_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ efk_enabled }}"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ elasticsearch_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ elasticsearch_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ elasticsearch_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">fluentd</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ efk_enabled }}"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ fluentd_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ fluentd_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ fluentd_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">kibana</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ efk_enabled }}"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ kibana_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ kibana_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ kibana_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">helm</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ helm_enabled }}"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ helm_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ helm_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ helm_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">tiller</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ helm_enabled }}"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ tiller_image_repo }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ tiller_image_tag }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ tiller_digest_checksum|default(None) }}"</span>
  <span class="token key atrule">vault</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">"{{ cert_management == 'vault' }}"</span>
    <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token string">"{{ vault_deployment_type != 'host' }}"</span>
    <span class="token key atrule">file</span><span class="token punctuation">:</span> <span class="token string">"{{ vault_deployment_type == 'host' }}"</span>
    <span class="token key atrule">dest</span><span class="token punctuation">:</span> <span class="token string">"vault/vault_{{ vault_version }}_linux_amd64.zip"</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token string">"0755"</span>
    <span class="token key atrule">owner</span><span class="token punctuation">:</span> <span class="token string">"vault"</span>
    <span class="token key atrule">repo</span><span class="token punctuation">:</span> <span class="token string">"{{ vault_image_repo }}"</span>
    <span class="token key atrule">sha256</span><span class="token punctuation">:</span> <span class="token string">"{{ vault_binary_checksum if vault_deployment_type == 'host' else vault_digest_checksum|d(none) }}"</span>
    <span class="token key atrule">source_url</span><span class="token punctuation">:</span> <span class="token string">"{{ vault_download_url }}"</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"{{ vault_image_tag }}"</span>
    <span class="token key atrule">unarchive</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"{{ vault_download_url }}"</span>
    <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"{{ vault_version }}"</span>

<span class="token key atrule">download_defaults</span><span class="token punctuation">:</span>
  <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">file</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">repo</span><span class="token punctuation">:</span> None
  <span class="token key atrule">tag</span><span class="token punctuation">:</span> None
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">dest</span><span class="token punctuation">:</span> None
  <span class="token key atrule">version</span><span class="token punctuation">:</span> None
  <span class="token key atrule">url</span><span class="token punctuation">:</span> None
  <span class="token key atrule">unarchive</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">owner</span><span class="token punctuation">:</span> kube
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> None

</pre>
<p><code>roles/download/defaults/main.yml</code></p>
<pre class="language-yml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> download_prep.yml
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> not skip_downloads<span class="token punctuation">|</span>default(false)

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"Download items"</span>
  <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">"download_{% if download.container %}container{% else %}file{% endif %}.yml"</span>
  <span class="token key atrule">vars</span><span class="token punctuation">:</span>
    <span class="token key atrule">download</span><span class="token punctuation">:</span> <span class="token string">"{{ download_defaults | combine(item.value) }}"</span>
  <span class="token key atrule">with_dict</span><span class="token punctuation">:</span> <span class="token string">"{{ downloads }}"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> not skip_downloads<span class="token punctuation">|</span>default(false)
    <span class="token punctuation">-</span> item.value.enabled

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"Sync container"</span>
  <span class="token key atrule">include</span><span class="token punctuation">:</span> sync_container.yml
  <span class="token key atrule">vars</span><span class="token punctuation">:</span>
    <span class="token key atrule">download</span><span class="token punctuation">:</span> <span class="token string">"{{ download_defaults | combine(item.value) }}"</span>
  <span class="token key atrule">with_dict</span><span class="token punctuation">:</span> <span class="token string">"{{ downloads }}"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> not skip_downloads<span class="token punctuation">|</span>default(false)
    <span class="token punctuation">-</span> item.value.enabled
    <span class="token punctuation">-</span> item.value.container
    <span class="token punctuation">-</span> download_run_once

</pre>
<p><code>roles/download/tasks/download_container.yml</code></p>
<pre class="language-yml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> container_download <span class="token punctuation">|</span> Make download decision if pull is required by tag or sha256
  <span class="token key atrule">include</span><span class="token punctuation">:</span> set_docker_image_facts.yml
  <span class="token key atrule">delegate_to</span><span class="token punctuation">:</span> <span class="token string">"{{ download_delegate if download_run_once or omit }}"</span>
  <span class="token key atrule">delegate_facts</span><span class="token punctuation">:</span> no
  <span class="token key atrule">run_once</span><span class="token punctuation">:</span> <span class="token string">"{{ download_run_once }}"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> download.enabled
    <span class="token punctuation">-</span> download.container
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> facts

<span class="token comment" spellcheck="true"># FIXME(mattymo): In Ansible 2.4 omitting download delegate is broken. Move back</span>
<span class="token comment" spellcheck="true">#                 to one task in the future.</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> container_download <span class="token punctuation">|</span> Download containers if pull is required or told to always pull (delegate)
  <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"{{ docker_bin_dir }}/docker pull {{ pull_args }}"</span>
  <span class="token key atrule">register</span><span class="token punctuation">:</span> pull_task_result
  <span class="token key atrule">until</span><span class="token punctuation">:</span> pull_task_result<span class="token punctuation">|</span>succeeded
  <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">4</span>
  <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token string">"{{ retry_stagger | random + 3 }}"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> download_run_once
    <span class="token punctuation">-</span> download.enabled
    <span class="token punctuation">-</span> download.container
    <span class="token punctuation">-</span> pull_required<span class="token punctuation">|</span>default(download_always_pull)
  <span class="token key atrule">delegate_to</span><span class="token punctuation">:</span> <span class="token string">"{{ download_delegate }}"</span>
  <span class="token key atrule">delegate_facts</span><span class="token punctuation">:</span> yes
  <span class="token key atrule">run_once</span><span class="token punctuation">:</span> yes

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> container_download <span class="token punctuation">|</span> Download containers if pull is required or told to always pull (all nodes)
  <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"{{ docker_bin_dir }}/docker pull {{ pull_args }}"</span>
  <span class="token key atrule">register</span><span class="token punctuation">:</span> pull_task_result
  <span class="token key atrule">until</span><span class="token punctuation">:</span> pull_task_result<span class="token punctuation">|</span>succeeded
  <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">4</span>
  <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token string">"{{ retry_stagger | random + 3 }}"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> not download_run_once
    <span class="token punctuation">-</span> download.enabled
    <span class="token punctuation">-</span> download.container
    <span class="token punctuation">-</span> pull_required<span class="token punctuation">|</span>default(download_always_pull)

</pre>
<pre class="language-yml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> file_download <span class="token punctuation">|</span> Downloading<span class="token punctuation">...</span>
  <span class="token key atrule">debug</span><span class="token punctuation">:</span>
    <span class="token key atrule">msg</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">"URL</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> download.url <span class="token punctuation">}</span><span class="token punctuation">}</span>"
      <span class="token punctuation">-</span> <span class="token key atrule">"Dest</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> download.dest <span class="token punctuation">}</span><span class="token punctuation">}</span>"

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> file_download <span class="token punctuation">|</span> Create dest directory
  <span class="token key atrule">file</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"{{local_release_dir}}/{{download.dest|dirname}}"</span>
    <span class="token key atrule">state</span><span class="token punctuation">:</span> directory
    <span class="token key atrule">recurse</span><span class="token punctuation">:</span> yes
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> download.enabled
    <span class="token punctuation">-</span> download.file

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> file_download <span class="token punctuation">|</span> Download item
  <span class="token key atrule">get_url</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"{{download.url}}"</span>
    <span class="token key atrule">dest</span><span class="token punctuation">:</span> <span class="token string">"{{local_release_dir}}/{{download.dest}}"</span>
    <span class="token key atrule">sha256sum</span><span class="token punctuation">:</span> <span class="token string">"{{download.sha256 | default(omit)}}"</span>
    <span class="token key atrule">owner</span><span class="token punctuation">:</span> <span class="token string">"{{ download.owner|default(omit) }}"</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token string">"{{ download.mode|default(omit) }}"</span>
  <span class="token key atrule">register</span><span class="token punctuation">:</span> get_url_result
  <span class="token key atrule">until</span><span class="token punctuation">:</span> <span class="token string">"'OK' in get_url_result.msg or 'file already exists' in get_url_result.msg"</span>
  <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">4</span>
  <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token string">"{{ retry_stagger | random + 3 }}"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> download.enabled
    <span class="token punctuation">-</span> download.file

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> file_download <span class="token punctuation">|</span> Extract archives
  <span class="token key atrule">unarchive</span><span class="token punctuation">:</span>
    <span class="token key atrule">src</span><span class="token punctuation">:</span> <span class="token string">"{{ local_release_dir }}/{{download.dest}}"</span>
    <span class="token key atrule">dest</span><span class="token punctuation">:</span> <span class="token string">"{{ local_release_dir }}/{{download.dest|dirname}}"</span>
    <span class="token key atrule">owner</span><span class="token punctuation">:</span> <span class="token string">"{{ download.owner|default(omit) }}"</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token string">"{{ download.mode|default(omit) }}"</span>
    <span class="token key atrule">copy</span><span class="token punctuation">:</span> no
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> download.enabled
    <span class="token punctuation">-</span> download.file
    <span class="token punctuation">-</span> download.unarchive<span class="token punctuation">|</span>default(False)

</pre>
<p><code>roles/download/tasks/download_prep.yml</code></p>
<pre class="language-yml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Register docker images info
  <span class="token key atrule">raw</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token punctuation">-</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span> docker_bin_dir <span class="token punctuation">}</span><span class="token punctuation">}</span>/docker images <span class="token punctuation">-</span>q <span class="token punctuation">|</span> xargs <span class="token punctuation">{</span><span class="token punctuation">{</span> docker_bin_dir <span class="token punctuation">}</span><span class="token punctuation">}</span>/docker inspect <span class="token punctuation">-</span>f "<span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">'{{'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> (index .RepoTags 0) <span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">'}}'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">'{{'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> (index .RepoDigests 0) <span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">'}}'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>" <span class="token punctuation">|</span> tr '\n' '<span class="token punctuation">,</span>'
  <span class="token key atrule">no_log</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">register</span><span class="token punctuation">:</span> docker_images
  <span class="token key atrule">failed_when</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">changed_when</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">check_mode</span><span class="token punctuation">:</span> no

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> container_download <span class="token punctuation">|</span> Create dest directory for saved/loaded container images
  <span class="token key atrule">file</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"{{local_release_dir}}/containers"</span>
    <span class="token key atrule">state</span><span class="token punctuation">:</span> directory
    <span class="token key atrule">recurse</span><span class="token punctuation">:</span> yes
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token number">0755</span>
    <span class="token key atrule">owner</span><span class="token punctuation">:</span> <span class="token string">"{{ansible_ssh_user|default(ansible_user_id)}}"</span>

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> container_download <span class="token punctuation">|</span> create local directory for saved/loaded container images
  <span class="token key atrule">file</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"{{local_release_dir}}/containers"</span>
    <span class="token key atrule">state</span><span class="token punctuation">:</span> directory
    <span class="token key atrule">recurse</span><span class="token punctuation">:</span> yes
  <span class="token key atrule">delegate_to</span><span class="token punctuation">:</span> localhost
  <span class="token key atrule">delegate_facts</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">become</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">run_once</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> download_run_once
    <span class="token punctuation">-</span> download_delegate == 'localhost'
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> localhost

</pre>
<p><code>roles/download/tasks/set_docker_image_facts.yml</code></p>
<pre class="language-yml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">set_fact</span><span class="token punctuation">:</span>
    <span class="token key atrule">pull_by_digest</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token punctuation">-</span>
      <span class="token punctuation">{</span>%<span class="token punctuation">-</span> if download.sha256 is defined and download.sha256 <span class="token tag">!=</span> '' <span class="token punctuation">-</span>%<span class="token punctuation">}</span>true<span class="token punctuation">{</span>%<span class="token punctuation">-</span> else <span class="token punctuation">-</span>%<span class="token punctuation">}</span>false<span class="token punctuation">{</span>%<span class="token punctuation">-</span> endif <span class="token punctuation">-</span>%<span class="token punctuation">}</span>

<span class="token punctuation">-</span> <span class="token key atrule">set_fact</span><span class="token punctuation">:</span>
    <span class="token key atrule">pull_args</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token punctuation">-</span>
      <span class="token punctuation">{</span>%<span class="token punctuation">-</span> if pull_by_digest %<span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span>download.repo<span class="token punctuation">}</span><span class="token punctuation">}</span>@sha256<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">{</span>download.sha256<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span>%<span class="token punctuation">-</span> else <span class="token punctuation">-</span>%<span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span>download.repo<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">{</span>download.tag<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span>%<span class="token punctuation">-</span> endif <span class="token punctuation">-</span>%<span class="token punctuation">}</span>

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Register docker images info
  <span class="token key atrule">raw</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token punctuation">-</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span> docker_bin_dir <span class="token punctuation">}</span><span class="token punctuation">}</span>/docker images <span class="token punctuation">-</span>q <span class="token punctuation">|</span> xargs <span class="token punctuation">{</span><span class="token punctuation">{</span> docker_bin_dir <span class="token punctuation">}</span><span class="token punctuation">}</span>/docker inspect <span class="token punctuation">-</span>f "<span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">'{{'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> (index .RepoTags 0) <span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">'}}'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">'{{'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> (index .RepoDigests 0) <span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">'}}'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>" <span class="token punctuation">|</span> tr '\n' '<span class="token punctuation">,</span><span class="token string">'
  no_log: true
  register: docker_images
  failed_when: false
  changed_when: false
  check_mode: no
  when: not download_always_pull

- set_fact:
    pull_required: >-
      {%- if pull_args in docker_images.stdout.split('</span><span class="token punctuation">,</span><span class="token string">') %}false{%- else -%}true{%- endif -%}
  when: not download_always_pull

- name: Check the local digest sha256 corresponds to the given image tag
  assert:
    that: "{{download.repo}}:{{download.tag}} in docker_images.stdout.split('</span><span class="token punctuation">,</span>')"
  <span class="token key atrule">when</span><span class="token punctuation">:</span> not download_always_pull and not pull_required and pull_by_digest
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> asserts

</pre>
<p><code>roles/download/tasks/sync_container.yml</code></p>
<pre class="language-yml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">set_fact</span><span class="token punctuation">:</span>
    <span class="token key atrule">fname</span><span class="token punctuation">:</span> <span class="token string">"{{local_release_dir}}/containers/{{download.repo|regex_replace('/|\0|:', '_')}}:{{download.tag|default(download.sha256)|regex_replace('/|\0|:', '_')}}.tar"</span>
  <span class="token key atrule">run_once</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> download.enabled
    <span class="token punctuation">-</span> download.container
    <span class="token punctuation">-</span> download_run_once
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> facts

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"container_download | Set default value for 'container_changed' to false"</span>
  <span class="token key atrule">set_fact</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_changed</span><span class="token punctuation">:</span> <span class="token string">"{{pull_required|default(false)}}"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> download.enabled
    <span class="token punctuation">-</span> download.container
    <span class="token punctuation">-</span> download_run_once

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"container_download | Update the 'container_changed' fact"</span>
  <span class="token key atrule">set_fact</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_changed</span><span class="token punctuation">:</span> <span class="token string">"{{ pull_required|default(false) or not 'up to date' in pull_task_result.stdout }}"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> download.enabled
    <span class="token punctuation">-</span> download.container
    <span class="token punctuation">-</span> download_run_once
    <span class="token punctuation">-</span> pull_required<span class="token punctuation">|</span>default(download_always_pull)
  <span class="token key atrule">run_once</span><span class="token punctuation">:</span> <span class="token string">"{{ download_run_once }}"</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> facts

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> container_download <span class="token punctuation">|</span> Stat saved container image
  <span class="token key atrule">stat</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"{{fname}}"</span>
  <span class="token key atrule">register</span><span class="token punctuation">:</span> img
  <span class="token key atrule">changed_when</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">delegate_to</span><span class="token punctuation">:</span> <span class="token string">"{{ download_delegate }}"</span>
  <span class="token key atrule">delegate_facts</span><span class="token punctuation">:</span> no
  <span class="token key atrule">become</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">run_once</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> download.enabled
    <span class="token punctuation">-</span> download.container
    <span class="token punctuation">-</span> download_run_once
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> facts

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> container_download <span class="token punctuation">|</span> save container images
  <span class="token key atrule">shell</span><span class="token punctuation">:</span> <span class="token string">"{{ docker_bin_dir }}/docker save {{ pull_args }} | gzip -{{ download_compress }} > {{ fname }}"</span>
  <span class="token key atrule">delegate_to</span><span class="token punctuation">:</span> <span class="token string">"{{ download_delegate }}"</span>
  <span class="token key atrule">delegate_facts</span><span class="token punctuation">:</span> no
  <span class="token key atrule">register</span><span class="token punctuation">:</span> saved
  <span class="token key atrule">run_once</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> download.enabled
    <span class="token punctuation">-</span> download.container
    <span class="token punctuation">-</span> download_run_once
    <span class="token punctuation">-</span> (ansible_os_family not in <span class="token punctuation">[</span><span class="token string">"CoreOS"</span><span class="token punctuation">,</span> <span class="token string">"Container Linux by CoreOS"</span><span class="token punctuation">]</span> or download_delegate == "localhost")
    <span class="token punctuation">-</span> (container_changed or not img.stat.exists)

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> container_download <span class="token punctuation">|</span> copy container images to ansible host
  <span class="token key atrule">synchronize</span><span class="token punctuation">:</span>
    <span class="token key atrule">src</span><span class="token punctuation">:</span> <span class="token string">"{{ fname }}"</span>
    <span class="token key atrule">dest</span><span class="token punctuation">:</span> <span class="token string">"{{ fname }}"</span>
    <span class="token key atrule">use_ssh_args</span><span class="token punctuation">:</span> <span class="token string">"{{ has_bastion | default(false) }}"</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> pull
  <span class="token key atrule">delegate_to</span><span class="token punctuation">:</span> localhost
  <span class="token key atrule">delegate_facts</span><span class="token punctuation">:</span> no
  <span class="token key atrule">run_once</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">become</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> download.enabled
    <span class="token punctuation">-</span> download.container
    <span class="token punctuation">-</span> download_run_once
    <span class="token punctuation">-</span> ansible_os_family not in <span class="token punctuation">[</span><span class="token string">"CoreOS"</span><span class="token punctuation">,</span> <span class="token string">"Container Linux by CoreOS"</span><span class="token punctuation">]</span>
    <span class="token punctuation">-</span> inventory_hostname == download_delegate
    <span class="token punctuation">-</span> download_delegate <span class="token tag">!=</span> "localhost"
    <span class="token punctuation">-</span> saved.changed

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> container_download <span class="token punctuation">|</span> upload container images to nodes
  <span class="token key atrule">synchronize</span><span class="token punctuation">:</span>
    <span class="token key atrule">src</span><span class="token punctuation">:</span> <span class="token string">"{{ fname }}"</span>
    <span class="token key atrule">dest</span><span class="token punctuation">:</span> <span class="token string">"{{ fname }}"</span>
    <span class="token key atrule">use_ssh_args</span><span class="token punctuation">:</span> <span class="token string">"{{ has_bastion | default(false) }}"</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> push
  <span class="token key atrule">delegate_to</span><span class="token punctuation">:</span> localhost
  <span class="token key atrule">delegate_facts</span><span class="token punctuation">:</span> no
  <span class="token key atrule">become</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">register</span><span class="token punctuation">:</span> get_task
  <span class="token key atrule">until</span><span class="token punctuation">:</span> get_task<span class="token punctuation">|</span>succeeded
  <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">4</span>
  <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token string">"{{ retry_stagger | random + 3 }}"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> download.enabled
    <span class="token punctuation">-</span> download.container
    <span class="token punctuation">-</span> download_run_once
    <span class="token punctuation">-</span> (ansible_os_family not in <span class="token punctuation">[</span><span class="token string">"CoreOS"</span><span class="token punctuation">,</span> <span class="token string">"Container Linux by CoreOS"</span><span class="token punctuation">]</span> and
      inventory_hostname <span class="token tag">!=</span> download_delegate or
      download_delegate == "localhost")
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> upload
    <span class="token punctuation">-</span> upgrade

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> container_download <span class="token punctuation">|</span> load container images
  <span class="token key atrule">shell</span><span class="token punctuation">:</span> <span class="token string">"{{ docker_bin_dir }}/docker load &lt; {{ fname }}"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> download.enabled
    <span class="token punctuation">-</span> download.container
    <span class="token punctuation">-</span> download_run_once
    <span class="token punctuation">-</span> (ansible_os_family not in <span class="token punctuation">[</span><span class="token string">"CoreOS"</span><span class="token punctuation">,</span> <span class="token string">"Container Linux by CoreOS"</span><span class="token punctuation">]</span> and
      inventory_hostname <span class="token tag">!=</span> download_delegate or download_delegate == "localhost")
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> upload
    <span class="token punctuation">-</span> upgrade

</pre>
<pre class="language-yml"><span class="token punctuation">---</span>
<span class="token key atrule">allow_duplicates</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

</pre>
<hr>
<h6 class="mume-header" id="prepare">prepare</h6>

<p>所有节点的网路之间可以互相通信。<br>
部署节点(这边为 master1)对其他节点不需要 SSH 密码即可登入。<br>
所有节点都拥有 Sudoer 权限，并且不需要输入密码。<br>
所有节点需要安装 Python。<br>
所有节点需要设定/etc/hosts解析到所有主机。<br>
修改所有节点的/etc/resolv.conf</p>
<p><code>ansible-playbook -i inventory/hosts_tests.yml prepare_pbk.yml</code></p>
<pre class="language-yml"><span class="token comment" spellcheck="true">## file: hosts_tests.yml</span>
<span class="token comment" spellcheck="true"># hosts</span>
localhost ansible_host=127.0.0.1 ansible_connection=local

<span class="token punctuation">[</span>tests<span class="token punctuation">]</span>
test    ansible_host=192.168.99.30
test01  ansible_host=192.168.99.31
test02  ansible_host=192.168.99.32
test03  ansible_host=192.168.99.33

<span class="token punctuation">[</span>tests<span class="token punctuation">:</span>vars<span class="token punctuation">]</span>
ansible_connection=ssh
ansible_user=vagrant
ansible_ssh_private_key_file="~/.ssh/vagrant.pem"

</pre>
<pre class="language-yml"><span class="token comment" spellcheck="true"># file: prepare_pbk.yml (inventory: sshca_hosts.yml)</span>
<span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> localhost tests
  <span class="token key atrule">become</span><span class="token punctuation">:</span> yes
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> wangwg2.sshca
    <span class="token comment" spellcheck="true"># - { role: wangwg2.sshca, sshca_user: "core" }</span>
    <span class="token punctuation">-</span> wangwg2.config
    <span class="token punctuation">-</span> wangwg2.hosts

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> localhost
  <span class="token key atrule">become</span><span class="token punctuation">:</span> yes
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> wangwg2.package

</pre>

      </div>
      <div class="md-sidebar-toc"><ul>
<li><a href="#ansible-playbook">ansible-playbook</a></li>
<li><a href="#role-kubespray-defaults">role: kubespray-defaults</a></li>
<li><a href="#role-bastion-ssh-config">role: bastion-ssh-config</a></li>
<li><a href="#role-bootstrap-os">role: bootstrap-os</a></li>
<li><a href="#role-kubernetespreinstall">role: kubernetes/preinstall</a></li>
<li><a href="#role-download">role: download</a></li>
<li><a href="#prepare">prepare</a></li>
</ul>
</div>
      <a id="sidebar-toc-btn">≡</a>
    </body>
    
    
    
    
    
    <script>
(function bindTaskListEvent() {
  var taskListItemCheckboxes = document.body.getElementsByClassName('task-list-item-checkbox')
  for (var i = 0; i < taskListItemCheckboxes.length; i++) {
    var checkbox = taskListItemCheckboxes[i]
    var li = checkbox.parentElement
    if (li.tagName !== 'LI') li = li.parentElement
    if (li.tagName === 'LI') {
      li.classList.add('task-list-item')
    }
  }
}())    
</script>
    
<script>

var sidebarTOCBtn = document.getElementById('sidebar-toc-btn')
sidebarTOCBtn.addEventListener('click', function(event) {
  event.stopPropagation()
  if (document.body.hasAttribute('html-show-sidebar-toc')) {
    document.body.removeAttribute('html-show-sidebar-toc')
  } else {
    document.body.setAttribute('html-show-sidebar-toc', true)
  }
})
</script>
      
  </html>